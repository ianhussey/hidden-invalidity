---
title: "Hidden invalidity among fifteen commonly used measures in social and personality psychology"
author: "Ian Hussey^[Ghent University. Email: ian.hussey@ugent.be]"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    code_folding: hide
    highlight: haddock
    theme: flatly
    toc: yes
    toc_float: yes
---

# To do

- reevaluate the inclusions of each full scale. 
- when this is solid, make sure stats are produced for all the remaining scales. some are now missing. this also fucks with the alluvial plot.
- based on this, check that the summary table counts are right (ie no double counting)
- should plots, tables etc split by full/split scales or not? does the full table mention this distinction?

# Decision making criteria

CFA

- Note somewhere that item reverse scoring has already been done; we are not interested in method factors such as reverse wordings, only interpretative factors.
- Fit indices
- Chi^2 assesses absolute fit. It is sample size dependant, and given our sample sizes will be significant in almost all cases and is therefore not informative. However, it is still important to report along with its degrees of freedom and associated p value (Kline, 2005; Hayduk et al, 2007). 
- Standardized Root Mean Residual (SRMR) assesses absolute fit too. 
- Tuckler-Lewis Fit Index (TLI) assesses Relative Fit. Compares to a null model, although is not a hypothesis test. Sample size independent, which is important here.
- Root Mean Square Error of Approximation (RMSEA) assesses Noncentrality.
- Bentlerâ€™s Comparative Fit Index (CLI) assesses Noncentrality.

- Hu and Bentler (1999) suggest a two-index presentation format of either SRMR with the CFI, TLI, or RMSEA. We'll report all four metrics and make a composite of all three two-index scores:
  - CLI >= .95 & SRMR <= .09
  - TFI >= .95 & SRMR <= .09
  - RMSEA <= .06 & SRMR <= .09
  - "We reccomend that practitioners use a cutoff value close to .95 for TLI (CFI) in combination with a cutoff value close to .09 for SRMR to evaluate model fit...A combination rule with RMSEA > .06 and SRMR > .09 (or .10) resulted in the least sum of Type I and II error rates (pps 27-28)."

MI tests

- MI via model fit indices (Chen, 2007; Putnick & Bornstein, 2016; see also Cheung & Rensvold, 2002; Meade et al., 2008).
- Configural invariance failure: same as CFA above.
- Metric and scalar invariance failure: delta_RMSEA > 0.01 or delta_CFI < -0.015

Overall scale evaluations

- For a scale to be rated "good" it must demonstrate good internally consistency, stable across time (both immediately and over time), it must conform to the expected factor structure, and it must be invariant across age and gender.
- Criterion: omega_t >= .7 & dependability >= .7 & stability >= .7 & CFA fit >= Mixed & MI passed for both median age and gender

```{r, include=FALSE}
knitr::opts_chunk$set(message=FALSE,
                      warning=FALSE,
                      cache=TRUE,
                      cache.lazy=TRUE)
```

```{r}

# dependencies
library(tidyverse)
library(lavaan)
library(semTools)
library(knitr)
library(kableExtra)
library(timesavers)  # library(devtools); install_github("ianhussey/timesavers")
library(moments)
library(plotrix)
library(lubridate)
library(psych)
library(rsample)
library(purrr)
library(ggalluvial)
library(patchwork)

# options
options(knitr.table.format = "html") # necessary configuration of tables

# disable scientific notation
options(scipen = 999) 

# set seed for reproducability
set.seed(42)

# print versions of packages used, R version, OS details.
writeLines(capture.output(sessionInfo()), "session_info.txt")

```

# Data

## Get data

```{r}

# get data
load("../data/trimmed_data.RData")

# trim to include only the first timepoint per user_id per scale
# ie exclude repeat participations on the same scale
trimmed_first_timepoint_per_user_per_scale <- trimmed_data %>%
  arrange(user_id, individual_differences_measure, datetime_ymdhms) %>%
  mutate(combined_var = paste0(user_id, individual_differences_measure)) %>%
  filter(combined_var != lag(combined_var)) %>%
  dplyr::select(-combined_var)

# manually compiled data on k items, k factors, and changes made to scales compared to original publications.
additional_scale_data <- read.csv("../data/additional_scale_data.csv")

```

## Subset data

By split scales

```{r}


# find median age to split by.
# Because individuals can participate more than once, and their age is recorded as age at participation, repeat participations
# overrepresent that participant's age when finding medians. Given we can't assume that repeate participations are evenly distributed across ages, # we must instead construct a median age for the whole sample. 
# This also ensures that the same median age is used for all scales.

median_age <- trimmed_first_timepoint_per_user_per_scale %>%
  group_by(user_id) %>%
  summarize(mean_age_by_participant = mean(age)) %>%  # given repeat presentations with changing age
  ungroup() %>%
  summarize(median_age = median(mean_age_by_participant)) %>%
  pull(median_age) %>%
  round(0)

# split scales

bfi_e_data <- trimmed_first_timepoint_per_user_per_scale %>%
  dplyr::select(bfi_e1, bfi_e2, bfi_e3, bfi_e4, bfi_e5, bfi_e6, bfi_e7, bfi_e8, sex, age) %>%
  na.omit() %>%
  mutate(age = ifelse(age < median_age, 0, 1))

bfi_c_data <- trimmed_first_timepoint_per_user_per_scale %>%
  dplyr::select(bfi_c1, bfi_c2, bfi_c3, bfi_c4, bfi_c5, bfi_c6, bfi_c7, bfi_c8, bfi_c9, sex, age) %>%
  na.omit() %>%
  mutate(age = ifelse(age < median_age, 0, 1))

bfi_n_data <- trimmed_first_timepoint_per_user_per_scale %>%
  dplyr::select(bfi_n1, bfi_n2, bfi_n3, bfi_n4, bfi_n5, bfi_n6, bfi_n7, bfi_n8, sex, age) %>%
  na.omit() %>%
  mutate(age = ifelse(age < median_age, 0, 1))

bfi_a_data <- trimmed_first_timepoint_per_user_per_scale %>%
  dplyr::select(bfi_a1, bfi_a2, bfi_a3, bfi_a4, bfi_a5, bfi_a6, bfi_a7, bfi_a8, bfi_a9, sex, age) %>%
  na.omit() %>%
  mutate(age = ifelse(age < median_age, 0, 1))

bfi_o_data <- trimmed_first_timepoint_per_user_per_scale %>%
  dplyr::select(bfi_o1, bfi_o2, bfi_o3, bfi_o4, bfi_o5, bfi_o6, bfi_o7, bfi_o8, bfi_o9, bfi_o10, sex, age) %>%
  na.omit() %>%
  mutate(age = ifelse(age < median_age, 0, 1))

bidr_im_data <- trimmed_first_timepoint_per_user_per_scale %>%
  dplyr::select(bidr_im1, bidr_im2, bidr_im3, bidr_im4, bidr_im5, bidr_im6, bidr_im7, bidr_im8, 
                bidr_im9, bidr_im10, bidr_im11, bidr_im12, bidr_im13, bidr_im14, bidr_im15, 
                bidr_im16, bidr_im17, bidr_im18, sex, age) %>%
  na.omit() %>%
  mutate(age = ifelse(age < median_age, 0, 1))

bidr_sde_data <- trimmed_first_timepoint_per_user_per_scale %>%
  dplyr::select(bidr_sde1, bidr_sde2, bidr_sde3, bidr_sde4, bidr_sde5, bidr_sde6, bidr_sde7, bidr_sde8, 
                bidr_sde9, bidr_sde10, bidr_sde11, bidr_sde12, bidr_sde13, bidr_sde14, bidr_sde15, bidr_sde16, 
                bidr_sde17, bidr_sde18, sex, age) %>%
  na.omit() %>%
  mutate(age = ifelse(age < median_age, 0, 1))

bjw_data <- trimmed_first_timepoint_per_user_per_scale %>%
  dplyr::select(bjw1, bjw2, bjw3, bjw4, bjw5, bjw6, sex, age) %>%
  na.omit() %>%
  mutate(age = ifelse(age < median_age, 0, 1))

brs_data <- trimmed_first_timepoint_per_user_per_scale %>%
  dplyr::select(brs1, brs2, brs3, brs4, brs5, brs6, brs7, brs8, brs9, brs10, brs11, brs12, brs13, brs14, brs15, brs16, sex, age) %>%
  na.omit() %>%
  mutate(age = ifelse(age < median_age, 0, 1))

he_data <- trimmed_first_timepoint_per_user_per_scale %>%
  dplyr::select(he1, he2, he3, he4, he5, he6, he7, he8, he9, he10, sex, age) %>%
  na.omit() %>%
  mutate(age = ifelse(age < median_age, 0, 1))

icat_o_data <- trimmed_first_timepoint_per_user_per_scale %>%
  dplyr::select(icat_o1, icat_o2, icat_o3, icat_o4, icat_o5, icat_o6, icat_o7, icat_o8, icat_o9, sex, age) %>%
  na.omit() %>%
  mutate(age = ifelse(age < median_age, 0, 1))

icat_s_data <- trimmed_first_timepoint_per_user_per_scale %>%
  dplyr::select(icat_s1, icat_s2, icat_s3, icat_s4, icat_s5, icat_s6, icat_s7, icat_s8, icat_s9, sex, age) %>%
  na.omit() %>%
  mutate(age = ifelse(age < median_age, 0, 1))

nfc_data <- trimmed_first_timepoint_per_user_per_scale %>%
  dplyr::select(nfc1, nfc2, nfc3, nfc4, nfc5, nfc6, nfc7, nfc8, nfc9, 
                nfc10, nfc11, nfc12, nfc13, nfc14, nfc15, nfc16, nfc17, nfc18, sex, age) %>%
  na.omit() %>%
  mutate(age = ifelse(age < median_age, 0, 1))

nfcc_pdc_data <- trimmed_first_timepoint_per_user_per_scale %>%
  dplyr::select(nfcc_p1, nfcc_p2, nfcc_p3, nfcc_p4, nfcc_p5, nfcc_p6, nfcc_p7, nfcc_p8, 
                nfcc_d1, nfcc_d2, nfcc_d3, nfcc_d4, nfcc_d5, nfcc_d6, nfcc_d7, 
                nfcc_c1, nfcc_c2, nfcc_c3, nfcc_c4, nfcc_c5, nfcc_c6, nfcc_c7, nfcc_c8, sex, age) %>%
  na.omit() %>%
  mutate(age = ifelse(age < median_age, 0, 1))

nfcc_ao_data <- trimmed_first_timepoint_per_user_per_scale %>%
  dplyr::select(nfcc_a1, nfcc_a2, nfcc_a3, nfcc_a4, nfcc_a5, nfcc_a6, nfcc_a7, nfcc_a8, 
                nfcc_o1, nfcc_o2, nfcc_o3, nfcc_o4, nfcc_o5, nfcc_o6, nfcc_o7, sex, age) %>%
  na.omit() %>%
  mutate(age = ifelse(age < median_age, 0, 1))

pe_data <- trimmed_first_timepoint_per_user_per_scale %>%
  dplyr::select(pe1, pe2, pe3, pe4, pe5, pe6, pe7, pe8, pe9, pe10, pe11, sex, age) %>%
  na.omit() %>%
  mutate(age = ifelse(age < median_age, 0, 1))

pns_data <- trimmed_first_timepoint_per_user_per_scale %>%
  dplyr::select(pns1, pns2, pns3, pns4, pns5, pns6, pns7, pns8, pns9, pns10, pns11, pns12, sex, age) %>%
  na.omit() %>%
  mutate(age = ifelse(age < median_age, 0, 1))

rse_data <- trimmed_first_timepoint_per_user_per_scale %>%
  dplyr::select(rse1, rse2, rse3, rse4, rse5, rse6, rse7, rse8, rse9, rse10, sex, age) %>%
  na.omit() %>%
  mutate(age = ifelse(age < median_age, 0, 1))

rwa_data <- trimmed_first_timepoint_per_user_per_scale %>%
  dplyr::select(rwa1, rwa2, rwa3, rwa4, rwa5, rwa6, rwa7, rwa8, rwa9, rwa10, 
                rwa11, rwa12, rwa13, rwa14, rwa15, rwa16, rwa17, rwa18, rwa19, rwa20, sex, age) %>%
  na.omit() %>%
  mutate(age = ifelse(age < median_age, 0, 1))

sdo_data <- trimmed_first_timepoint_per_user_per_scale %>%
  dplyr::select(sdo1, sdo2, sdo3, sdo4, sdo5, sdo6, sdo7, sdo8, sdo9, sdo10, sdo11, sdo12, sex, age) %>%
  na.omit() %>%
  mutate(age = ifelse(age < median_age, 0, 1))

sm_data <- trimmed_first_timepoint_per_user_per_scale %>%
  dplyr::select(sm1, sm2, sm3, sm4, sm5, sm6, sm7, sm8, sm9, sm10, sm11, sm12, sm13, sm14, sm15, sm16, sm17, sm18, sex, age) %>%
  na.omit() %>%
  mutate(age = ifelse(age < median_age, 0, 1))

soc_ic_data <- trimmed_first_timepoint_per_user_per_scale %>%
  dplyr::select(soc_ic1, soc_ic2, soc_ic3, soc_ic4, soc_ic5, soc_ic6, soc_ic7, soc_ic8, soc_ic9, sex, age) %>%
  na.omit() %>%
  mutate(age = ifelse(age < median_age, 0, 1))

soc_pe_data <- trimmed_first_timepoint_per_user_per_scale %>%
  dplyr::select(soc_pe1, soc_pe2, soc_pe3, soc_pe4, soc_pe5, soc_pe6, soc_pe7, soc_pe8, soc_pe9, soc_pe10, sex, age) %>%
  na.omit() %>%
  mutate(age = ifelse(age < median_age, 0, 1))

```

By full scales

NB excludes users that completed the two halves more than 24 hours apart.

```{r}

# determine which participants have full scale data

# function to return the user_ids and datetimes with a given scale
user_id_by_scale <- function(scale_name){
  trimmed_data %>%
    dplyr::select(user_id, individual_differences_measure, datetime_ymdhms) %>%
    filter(individual_differences_measure == scale_name) %>%
    arrange(user_id, individual_differences_measure, datetime_ymdhms) %>%
    mutate(combined_var = paste0(user_id, individual_differences_measure),
           instance = ifelse(combined_var == lag(combined_var), 2, 1)) %>%
    filter(instance == 1) %>%
    select(-combined_var, -instance)
}

# apply for each scale pair

## This contains some magic on two fronts, neither of which I can remember the hows and whys of.
## 1. I cross semi_join in two directions to find matching cases. Can't remember why but it works.
## 2. I then do some reshaping to find the absolute time between the completions of the two scales, trim 
## participants who take longer than 1 day (24 hours), and reshape back to an original format that works with 
## the subsequent functions below. Refactoring into a function or to make the logic more transparent would take time
## and, given it all works, Im not motivated to do it. If you are reading this comment and you're not me, 
## I am extremely suprised. Please accept a) my congratulations for doing such deep dives into other peoples code, 
## and b) my apologies for what follows. Kanye/Oprah-2020.

# bfi
user_ids_with_bfi_1      <- user_id_by_scale(scale_name = "BFI-Part 1")
user_ids_with_bfi_2      <- user_id_by_scale(scale_name = "BFI-Part 2")

user_ids_with_bfi_1_2    <- semi_join(user_ids_with_bfi_1, 
                                      user_ids_with_bfi_2, 
                                      by = "user_id")

user_ids_with_bfi_2_2    <- semi_join(user_ids_with_bfi_2, 
                                      user_ids_with_bfi_1, 
                                      by = "user_id")

user_ids_with_both_bfi   <- rbind(user_ids_with_bfi_1_2, user_ids_with_bfi_2_2) %>%
  spread(individual_differences_measure, datetime_ymdhms) %>%
  dplyr::rename(first_scale = !!names(.[2]),
                second_scale = !!names(.[3])) %>%
  mutate(days_to_followup = as.duration(interval(start = ymd_hms(first_scale), 
                                                 end = ymd_hms(second_scale))),
         days_to_followup = abs(round(as.numeric(days_to_followup, "days"), 3))) %>%
  filter(days_to_followup <= 1) %>%
  gather(individual_differences_measure, datetime_ymdhms, c("first_scale", "second_scale")) %>%
  mutate(individual_differences_measure = recode(individual_differences_measure,
                                                 "first_scale" = "BFI-Part 1",
                                                 "second_scale" = "BFI-Part 2"))

# bidr
user_ids_with_bidr_im    <- user_id_by_scale(scale_name = "BIDR-IM")
user_ids_with_bidr_sde   <- user_id_by_scale(scale_name = "BIDR-SDE")

user_ids_with_bidr_im_2  <- semi_join(user_ids_with_bidr_im, 
                                      user_ids_with_bidr_sde, 
                                      by = "user_id")

user_ids_with_bidr_sde_2 <- semi_join(user_ids_with_bidr_sde, 
                                      user_ids_with_bidr_im, 
                                      by = "user_id")

user_ids_with_both_bidr  <- rbind(user_ids_with_bidr_im_2, user_ids_with_bidr_sde_2) %>%
  spread(individual_differences_measure, datetime_ymdhms) %>%
  dplyr::rename(first_scale = !!names(.[2]),
                second_scale = !!names(.[3])) %>%
  mutate(days_to_followup = as.duration(interval(start = ymd_hms(first_scale), 
                                                 end = ymd_hms(second_scale))),
         days_to_followup = abs(round(as.numeric(days_to_followup, "days"), 3))) %>%
  filter(days_to_followup <= 1) %>%
  gather(individual_differences_measure, datetime_ymdhms, c("first_scale", "second_scale")) %>%
  mutate(individual_differences_measure = recode(individual_differences_measure,
                                                 "first_scale" = "BIDR-IM",
                                                 "second_scale" = "BIDR-SDE"))

# icat
user_ids_with_icat_o     <- user_id_by_scale(scale_name = "ICAT-O")
user_ids_with_icat_s     <- user_id_by_scale(scale_name = "ICAT-S")

user_ids_with_icat_o_2   <- semi_join(user_ids_with_icat_o, 
                                      user_ids_with_icat_s, 
                                      by = "user_id")

user_ids_with_icat_s_2   <- semi_join(user_ids_with_icat_s, 
                                      user_ids_with_icat_o, 
                                      by = "user_id")

user_ids_with_both_icat  <- rbind(user_ids_with_icat_o_2, user_ids_with_icat_s_2) %>%
  spread(individual_differences_measure, datetime_ymdhms) %>%
  dplyr::rename(first_scale = !!names(.[2]),
                second_scale = !!names(.[3])) %>%
  mutate(days_to_followup = as.duration(interval(start = ymd_hms(first_scale), 
                                                 end = ymd_hms(second_scale))),
         days_to_followup = abs(round(as.numeric(days_to_followup, "days"), 3))) %>%
  filter(days_to_followup <= 1) %>%
  gather(individual_differences_measure, datetime_ymdhms, c("first_scale", "second_scale")) %>%
  mutate(individual_differences_measure = recode(individual_differences_measure,
                                                 "first_scale" = "ICAT-O",
                                                 "second_scale" = "ICAT-S"))

# nfcc
user_ids_with_nfcc_1     <- user_id_by_scale(scale_name = "NFCC, Part 1")
user_ids_with_nfcc_2     <- user_id_by_scale(scale_name = "NFCC, Part 2")

user_ids_with_nfcc_1_2   <- semi_join(user_ids_with_nfcc_1, 
                                      user_ids_with_nfcc_2, 
                                      by = "user_id")

user_ids_with_nfcc_2_2   <- semi_join(user_ids_with_nfcc_2, 
                                      user_ids_with_nfcc_1, 
                                      by = "user_id")

user_ids_with_both_nfcc  <- rbind(user_ids_with_nfcc_1_2, user_ids_with_nfcc_2_2) %>%
  spread(individual_differences_measure, datetime_ymdhms) %>%
  dplyr::rename(first_scale = !!names(.[2]),
                second_scale = !!names(.[3])) %>%
  mutate(days_to_followup = as.duration(interval(start = ymd_hms(first_scale), 
                                                 end = ymd_hms(second_scale))),
         days_to_followup = abs(round(as.numeric(days_to_followup, "days"), 3))) %>%
  filter(days_to_followup <= 1) %>%
  gather(individual_differences_measure, datetime_ymdhms, c("first_scale", "second_scale")) %>%
  mutate(individual_differences_measure = recode(individual_differences_measure,
                                                 "first_scale" = "NFCC, Part 1",
                                                 "second_scale" = "NFCC, Part 2"))

# soc
user_ids_with_soc_ic     <- user_id_by_scale(scale_name = "SOC-IC")
user_ids_with_soc_pe     <- user_id_by_scale(scale_name = "SOC-PE")

user_ids_with_soc_ic_2   <- semi_join(user_ids_with_soc_ic, 
                                      user_ids_with_soc_pe, 
                                      by = "user_id")

user_ids_with_soc_pe_2   <- semi_join(user_ids_with_soc_pe, 
                                      user_ids_with_soc_ic, 
                                      by = "user_id")

user_ids_with_both_soc   <- rbind(user_ids_with_soc_ic_2, user_ids_with_soc_pe_2) %>%
  spread(individual_differences_measure, datetime_ymdhms) %>%
  dplyr::rename(first_scale = !!names(.[2]),
                second_scale = !!names(.[3])) %>%
  mutate(days_to_followup = as.duration(interval(start = ymd_hms(first_scale), 
                                                 end = ymd_hms(second_scale))),
         days_to_followup = abs(round(as.numeric(days_to_followup, "days"), 3))) %>%
  filter(days_to_followup <= 1) %>%
  gather(individual_differences_measure, datetime_ymdhms, c("first_scale", "second_scale")) %>%
  mutate(individual_differences_measure = recode(individual_differences_measure,
                                                 "first_scale" = "SOC-IC",
                                                 "second_scale" = "SOC-PE"))

# join half scales and reduce to one row per user id
join_full_scale <- function(data_1, data_2){
  data_1 %>%
    semi_join(data_2, 
              by = c("user_id", "individual_differences_measure", "datetime_ymdhms")) %>%
    select(user_id, contains("bfi_"), contains("bidr_"), 
           contains("icat_"), contains("nfcc_"), contains("soc_"), -contains("_subscale")) %>%
    # hacky way to collapse two rows per user_id into one. Function further below removes the NaNs it creates.
    # to anyone who reads this hideous solution: I'm sorry. I'm sure there's a more tidyverse way of doing this, but it's 2am.
    group_by(user_id) %>%
    summarize_all(funs(mean(., na.rm = TRUE))) %>%
    ungroup()
}

full_scales_temp <- 
  rbind(join_full_scale(data_1 = trimmed_data, data_2 = user_ids_with_both_bfi),
        join_full_scale(data_1 = trimmed_data, data_2 = user_ids_with_both_bidr),
        join_full_scale(data_1 = trimmed_data, data_2 = user_ids_with_both_icat),
        join_full_scale(data_1 = trimmed_data, data_2 = user_ids_with_both_nfcc),
        join_full_scale(data_1 = trimmed_data, data_2 = user_ids_with_both_soc))

# replace all NaN in this data frame with NA
is.nan.data.frame <- function(x){do.call(cbind, lapply(x, is.nan))}
full_scales_temp[is.nan.data.frame(full_scales_temp)] <- NA

# age, gender, and distinct user_ids for joining below
demographics_temp <- trimmed_data %>%
  select(user_id, age, sex) %>%
  distinct(user_id, .keep_all = TRUE)

# create individual_differences_measure variable. difficult to do this by joining given multiple individual_differences_measures by user_id
full_scales_data <- full_scales_temp %>%
  mutate(Scale = ifelse(!is.na(bfi_e1), "BFI", 
                        ifelse(!is.na(bidr_im1), "BIDR", 
                               ifelse(!is.na(icat_o1), "ICAT", 
                                      ifelse(!is.na(nfcc_p1), "NFCC", 
                                             ifelse(!is.na(soc_ic1), "SOC", NA)))))) %>%
  left_join(demographics_temp, by = "user_id")

# summaries of data present

# for joining again later below
N_with_full_scale_data <- nrow(full_scales_data)

percent_with_full_scale_data <- round(nrow(full_scales_data) / nrow(demographics_temp)*100, 2)

# N per full scale - also used further below
n_per_full_scale <- full_scales_data %>%  
  count(Scale) 

n_per_full_scale %>% 
  kable() %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

```

`r N_with_full_scale_data` participants (`r percent_with_full_scale_data`%) had full scale available from scales that were split in two and had completed both halves within 24 hours.

```{r}

# subset full scales data

# select data
bfi_data <- full_scales_data %>%
  dplyr::select(bfi_e1, bfi_e2, bfi_e3, bfi_e4, bfi_e5, bfi_e6, bfi_e7, bfi_e8, 
                bfi_c1, bfi_c2, bfi_c3, bfi_c4, bfi_c5, bfi_c6, bfi_c7, bfi_c8, bfi_c9, 
                bfi_n1, bfi_n2, bfi_n3, bfi_n4, bfi_n5, bfi_n6, bfi_n7, bfi_n8, 
                bfi_a1, bfi_a2, bfi_a3, bfi_a4, bfi_a5, bfi_a6, bfi_a7, bfi_a8, bfi_a9, 
                bfi_o1, bfi_o2, bfi_o3, bfi_o4, bfi_o5, bfi_o6, bfi_o7, bfi_o8, bfi_o9, bfi_o10, 
                sex, age) %>%
  na.omit() %>%
  mutate(age = ifelse(age < median_age, 0, 1))

bidr_data <- full_scales_data %>%
  dplyr::select(bidr_im1, bidr_im2, bidr_im3, bidr_im4, bidr_im5, bidr_im6, bidr_im7, bidr_im8, 
                bidr_im9, bidr_im10, bidr_im11, bidr_im12, bidr_im13, bidr_im14, bidr_im15, 
                bidr_im16, bidr_im17, bidr_im18, 
                bidr_sde1, bidr_sde2, bidr_sde3, bidr_sde4, bidr_sde5, bidr_sde6, bidr_sde7, bidr_sde8, 
                bidr_sde9, bidr_sde10, bidr_sde11, bidr_sde12, bidr_sde13, bidr_sde14, bidr_sde15,
                bidr_sde16, bidr_sde17, bidr_sde18, sex, age) %>%
  na.omit() %>%
  mutate(age = ifelse(age < median_age, 0, 1))

icat_data <- full_scales_data %>%
  dplyr::select(icat_o1, icat_o2, icat_o3, icat_o4, icat_o5, icat_o6, icat_o7, icat_o8, icat_o9, 
                icat_s1, icat_s2, icat_s3, icat_s4, icat_s5, icat_s6, icat_s7, icat_s8, icat_s9, 
                sex, age) %>%
  na.omit() %>%
  mutate(age = ifelse(age < median_age, 0, 1))

nfcc_data <- full_scales_data %>%
  dplyr::select(nfcc_p1, nfcc_p2, nfcc_p3, nfcc_p4, nfcc_p5, nfcc_p6, nfcc_p7, nfcc_p8, 
                nfcc_d1, nfcc_d2, nfcc_d3, nfcc_d4, nfcc_d5, nfcc_d6, nfcc_d7, 
                nfcc_c1, nfcc_c2, nfcc_c3, nfcc_c4, nfcc_c5, nfcc_c6, nfcc_c7, nfcc_c8, 
                nfcc_a1, nfcc_a2, nfcc_a3, nfcc_a4, nfcc_a5, nfcc_a6, nfcc_a7, nfcc_a8, 
                nfcc_o1, nfcc_o2, nfcc_o3, nfcc_o4, nfcc_o5, nfcc_o6, nfcc_o7, sex, age) %>%
  na.omit() %>%
  mutate(age = ifelse(age < median_age, 0, 1))

soc_data <- full_scales_data %>%
  dplyr::select(soc_ic1, soc_ic2, soc_ic3, soc_ic4, soc_ic5, soc_ic6, soc_ic7, soc_ic8, soc_ic9, 
                soc_pe1, soc_pe2, soc_pe3, soc_pe4, soc_pe5, soc_pe6, soc_pe7, soc_pe8, soc_pe9, soc_pe10,
                sex, age) %>%
  na.omit() %>%
  mutate(age = ifelse(age < median_age, 0, 1))

```

### Test-retest data

```{r}

## get and reshape data

# separate out user_ids with two timepoints per scale
user_ids_with_two_timepoints_per_scale <- trimmed_data %>%
  dplyr::select(user_id, session_id, datetime_ymdhms, individual_differences_measure) %>%
  count(user_id, individual_differences_measure) %>%
  filter(n >= 2)

# semi join with full data
two_timepoints_per_scale <- trimmed_data %>%
  semi_join(user_ids_with_two_timepoints_per_scale, 
            by = c("user_id", "individual_differences_measure")) %>%
  arrange(user_id, individual_differences_measure, datetime_ymdhms) %>%
  mutate(combined_var = paste0(user_id, individual_differences_measure),
         timepoint = ifelse(combined_var == lag(combined_var, n = 2), 3, 
                            ifelse(combined_var == lag(combined_var, n = 1), 2 , 1)),
         # lag can't operate on the first row, so mung a solution to this.
         timepoint = ifelse(is.na(timepoint), 1, timepoint)) %>%
  filter(timepoint %in% c(1, 2)) %>%
  dplyr::select(user_id, datetime_ymdhms, timepoint, individual_differences_measure,
                individual_differences_sum_score)

# rehape t1
timepoint_1 <- two_timepoints_per_scale %>%
  filter(timepoint == 1) %>%
  rename(individual_differences_sum_score_t1 = individual_differences_sum_score,
         datetime_ymdhms_t1 = datetime_ymdhms) %>%
  dplyr::select(-timepoint)

# reshape t2
timepoint_2 <- two_timepoints_per_scale %>%
  filter(timepoint == 2) %>%
  rename(individual_differences_sum_score_t2 = individual_differences_sum_score,
         datetime_ymdhms_t2 = datetime_ymdhms) %>%
  dplyr::select(-timepoint)

# join
two_timepoint_scores_temp <- timepoint_1 %>%
  left_join(timepoint_2, by = c("user_id", "individual_differences_measure")) %>%
  mutate(days_to_followup = as.duration(interval(start = ymd_hms(datetime_ymdhms_t1), 
                                                 end = ymd_hms(datetime_ymdhms_t2))),
         days_to_followup = round(as.numeric(days_to_followup, "days"), 3)) %>%
  na.omit

## for the BFI scales, we need the subscale sum score rather than the full scale sum score. 

# bfi t1
timepoint_1_bfi_temp <- two_timepoint_scores_temp %>%
  filter(individual_differences_measure %in% c("BFI-Part 1", "BFI-Part 2")) %>%
  select(user_id, datetime_ymdhms_t1, individual_differences_measure)

timepoint_1_bfi <- trimmed_data %>%
  rename(datetime_ymdhms_t1 = datetime_ymdhms) %>%
  semi_join(timepoint_1_bfi_temp, 
            by = c("user_id", "individual_differences_measure", "datetime_ymdhms_t1")) %>%
  select(user_id, datetime_ymdhms_t1, BFI_E_subscale, BFI_C_subscale, BFI_N_subscale, BFI_A_subscale, BFI_O_subscale) %>%
  rename(BFI_E = BFI_E_subscale,
         BFI_C = BFI_C_subscale,
         BFI_N = BFI_N_subscale,
         BFI_A = BFI_A_subscale,
         BFI_O = BFI_O_subscale) %>%
  gather(individual_differences_measure, individual_differences_sum_score_t1, 
         c("BFI_E", "BFI_C", "BFI_N", "BFI_A", "BFI_O")) %>%
  na.omit

# bfi t2
timepoint_2_bfi_temp <- two_timepoint_scores_temp %>%
  filter(individual_differences_measure %in% c("BFI-Part 1", "BFI-Part 2")) %>%
  select(user_id, datetime_ymdhms_t2, individual_differences_measure)

timepoint_2_bfi <- trimmed_data %>%
  rename(datetime_ymdhms_t2 = datetime_ymdhms) %>%
  semi_join(timepoint_2_bfi_temp, 
            by = c("user_id", "individual_differences_measure", "datetime_ymdhms_t2")) %>%
  select(user_id, datetime_ymdhms_t2, BFI_E_subscale, BFI_C_subscale, BFI_N_subscale, BFI_A_subscale, BFI_O_subscale) %>%
  rename(BFI_E = BFI_E_subscale,
         BFI_C = BFI_C_subscale,
         BFI_N = BFI_N_subscale,
         BFI_A = BFI_A_subscale,
         BFI_O = BFI_O_subscale) %>%
  gather(individual_differences_measure, individual_differences_sum_score_t2, 
         c("BFI_E", "BFI_C", "BFI_N", "BFI_A", "BFI_O")) %>%
  na.omit

two_timepoint_scores_bfi <- 
  full_join(timepoint_1_bfi, timepoint_2_bfi, by = c("user_id", "individual_differences_measure")) %>%
  mutate(days_to_followup = as.duration(interval(start = ymd_hms(datetime_ymdhms_t1), 
                                                 end = ymd_hms(datetime_ymdhms_t2))),
         days_to_followup = round(as.numeric(days_to_followup, "days"), 3))


## exclude the bfi sum scores and replace with the subscale sum scores


two_timepoint_scores <- two_timepoint_scores_temp %>%
  filter(!(individual_differences_measure %in% c("BFI-Part 1", "BFI-Part 2"))) %>%
  rbind(two_timepoint_scores_bfi)


## quick analyses of timepoint data to understand distributions

# percent with test retest data
n_with_test_retest_data <- round(nrow(two_timepoint_scores), 1)

percent_with_test_retest_data <- round(nrow(two_timepoint_scores) / nrow(trimmed_first_timepoint_per_user_per_scale)*100, 1)

# days to follow-up
two_timepoint_scores %>%
  summarise(min = min(days_to_followup),
            max = max(days_to_followup),
            sd = sd(days_to_followup),
            median = median(days_to_followup),
            mean = mean(days_to_followup)) %>%
  round_df(2) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

data.frame(quantile = quantile(two_timepoint_scores$days_to_followup)) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

```

`r n_with_test_retest_data` user_ids (`r percent_with_test_retest_data`%) had test-retest data on the same scale available. 

Retest times are highly skewed. Most reparticipated the same day, the vast majority within a week, but some up to multiple years later. 

# Scale details

Used later on in several tests or for reporting

```{r}

# trim data
n_per_scale <- trimmed_first_timepoint_per_user_per_scale %>%
  rename(Scale = individual_differences_measure) %>%
  count(Scale) %>%
  mutate(Scale = dplyr::recode(Scale,
                               "BFI-Part 1" = "BFI-E",
                               "BFI-Part 2" = "BFI-A",
                               "NFCC, Part 1" = "NFCC-PDC",
                               "NFCC, Part 2" = "NFCC-AO"))

## add n per scale for bfi subscales
temp_ns <- data.frame(Scale = c("BFI-C", "BFI-N", "BFI-O"),
                      n = c(NA, NA, NA)) 

n_per_scale_with_bfi_subscales <- n_per_scale %>%
  bind_rows(temp_ns) %>%
  # hacky solution to populate the BFI1 and BFI2 Ns into all cells
  mutate(n = ifelse(Scale == "BFI-C", n[.$Scale == "BFI-E"], n),
         n = ifelse(Scale == "BFI-N", n[.$Scale == "BFI-E"], n),
         n = ifelse(Scale == "BFI-O", n[.$Scale == "BFI-A"], n),
         Scale = as.factor(as.character(Scale))) %>%
  mutate(Scale = dplyr::recode(Scale,
                               "BFI-E"    = "Big 5 Inventory - E",
                               "BFI-C"    = "Big 5 Inventory - C",
                               "BFI-N"    = "Big 5 Inventory - N",
                               "BFI-A"    = "Big 5 Inventory - A",
                               "BFI-O"    = "Big 5 Inventory - O",
                               "BIDR-IM"  = "Balanced Inventory of Desirable Responding - Impression Management",
                               "BIDR-SDE" = "Balanced Inventory of Desirable Responding - Self Deception",
                               "BJW"      = "Belief in a Just World: General Just World Scale",
                               "BRS"      = "Bayesian Racism",
                               "HE"       = "Humanitarianism-Egalitarianism",
                               "ICAT-O"   = "Intuitions about Controllability and Awareness of Thoughts - Others",
                               "ICAT-S"   = "Intuitions about Controllability and Awareness of Thoughts - Self",
                               "NFC"      = "Need for Cognition",
                               "NFCC-PDC"  = "Need for Cognitive Closure - P,D,CM",
                               "NFCC-AO"  = "Need for Cognitive Closure - O,A",
                               "PE"       = "Protestant Ethic",
                               "PNS"      = "Personal Need for Structure",
                               "RSE"      = "Rosenberg Self-Esteem",
                               "RWA"      = "Ring-Wing Authoritarianism",
                               "SDO"      = "Social Dominance Orientation",
                               "SM"       = "Self-Monitoring",
                               "SOC-IC"   = "Spheres of Control - Interpersonal Control",
                               "SOC-PE"   = "Spheres of Control - Personal Efficacy"))

# remove redundant objects to keep the environment tidy
rm(temp_ns)

```

## Scale descriptives

Items per scale

```{r}

additional_scale_data %>%
  summarize(mean = round(mean(Items), 1),
            sd = round(sd(Items), 1),
            min = round(min(Items), 1),
            max = round(max(Items), 1)) %>%
  gather() %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

```

Factors per scale

```{r}

additional_scale_data %>%
  summarize(mean = round(mean(Items), 1),
            sd = round(sd(Items), 1),
            min = round(min(Items), 1),
            max = round(max(Items), 1)) %>%
  gather() %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

```

## Models

```{r}

# split scale models
bfi_e_model <- "E =~ bfi_e1 + bfi_e2 + bfi_e3 + bfi_e4 + bfi_e5 + bfi_e6 + bfi_e7 + bfi_e8" 

bfi_c_model <- "C =~ bfi_c1 + bfi_c2 + bfi_c3 + bfi_c4 + bfi_c5 + bfi_c6 + bfi_c7 + bfi_c8 + bfi_c9" 

bfi_n_model <- "N =~ bfi_n1 + bfi_n2 + bfi_n3 + bfi_n4 + bfi_n5 + bfi_n6 + bfi_n7 + bfi_n8" 

bfi_a_model <- "A =~ bfi_a1 + bfi_a2 + bfi_a3 + bfi_a4 + bfi_a5 + bfi_a6 + bfi_a7 + bfi_a8 + bfi_a9" 

bfi_o_model <- "O =~ bfi_o1 + bfi_o2 + bfi_o3 + bfi_o4 + bfi_o5 + bfi_o6 + bfi_o7 + bfi_o8 + bfi_o9 + bfi_o10" 

bidr_im_model <- "IM =~ bidr_im1 + bidr_im2 + bidr_im3 + bidr_im4 + bidr_im5 + bidr_im6 + bidr_im7 + bidr_im8 + bidr_im9 + 
                        bidr_im10 + bidr_im11 + bidr_im12 + bidr_im13 + bidr_im14 + bidr_im15 + bidr_im16 + bidr_im17 + bidr_im18" 

bidr_sde_model <- "SDE =~ bidr_sde1 + bidr_sde2 + bidr_sde3 + bidr_sde4 + bidr_sde5 + bidr_sde6 + bidr_sde7 + bidr_sde8 + bidr_sde9 + bidr_sde10 + bidr_sde11 + bidr_sde12 + bidr_sde13 + bidr_sde14 + bidr_sde15 + bidr_sde16 + bidr_sde17 + bidr_sde18" 

bjw_model <- "BJW =~ bjw1 + bjw2 + bjw3 + bjw4 + bjw5 + bjw6" 

brs_model <- "BRS =~ brs1 + brs2 + brs3 + brs4 + brs5 + brs6 + brs7 + brs8 + brs9 + brs10 + brs11 + brs12 + brs13 + brs14 + brs15 + brs16" 

he_model <- "HE =~ he1 + he2 + he3 + he4 + he5 + he6 + he7 + he8 + he9 + he10" 

icat_o_model <- "ICAT_O =~ icat_o1 + icat_o2 + icat_o3 + icat_o4 + icat_o5 + icat_o6 + icat_o7 + icat_o8 + icat_o9" 

icat_s_model <- "ICAT_S =~ icat_s1 + icat_s2 + icat_s3 + icat_s4 + icat_s5 + icat_s6 + icat_s7 + icat_s8 + icat_s9" 

nfc_model <- "NFC =~ nfc1 + nfc2 + nfc3 + nfc4 + nfc5 + nfc6 + nfc7 + nfc8 + nfc9 + nfc10 + nfc11 + nfc12 + nfc13 + nfc14 + nfc15 + nfc16 + nfc17 + nfc18" 

nfcc_pdc_model <- "P =~ nfcc_p1 + nfcc_p2 + nfcc_p3 + nfcc_p4 + nfcc_p5 + nfcc_p6 + nfcc_p7 + nfcc_p8
                   D =~ nfcc_d1 + nfcc_d2 + nfcc_d3 + nfcc_d4 + nfcc_d5 + nfcc_d6 + nfcc_d7
                   C =~ nfcc_c1 + nfcc_c2 + nfcc_c3 + nfcc_c4 + nfcc_c5 + nfcc_c6 + nfcc_c7 + nfcc_c8" 

nfcc_ao_model <- "A =~ nfcc_a1 + nfcc_a2 + nfcc_a3 + nfcc_a4 + nfcc_a5 + nfcc_a6 + nfcc_a7 + nfcc_a8
                  O =~ nfcc_o1 + nfcc_o2 + nfcc_o3 + nfcc_o4 + nfcc_o5 + nfcc_o6 + nfcc_o7" 

pe_model <- "PE =~ pe1 + pe2 + pe3 + pe4 + pe5 + pe6 + pe7 + pe8 + pe9 + pe10 + pe11" 

pns_model <- "PNS =~ pns1 + pns2 + pns3 + pns4 + pns5 + pns6 + pns7 + pns8 + pns9 + pns10 + pns11 + pns12" 

rse_model <- "RSE =~ rse1 + rse2 + rse3 + rse4 + rse5 + rse6 + rse7 + rse8 + rse9 + rse10" 

rwa_model <- "RWA =~ rwa1 + rwa2 + rwa3 + rwa4 + rwa5 + rwa6 + rwa7 + rwa8 + rwa9 + rwa10 + rwa11 + rwa12 + rwa13 + rwa14 + rwa15 + rwa16 + rwa17 + rwa18 + rwa19 + rwa20" 

sdo_model <- "SDO =~ sdo1 + sdo2 + sdo3 + sdo4 + sdo5 + sdo6 + sdo7 + sdo8 + sdo9 + sdo10 + sdo11 + sdo12" 

sm_model <- "SM =~ sm1 + sm2 + sm3 + sm4 + sm5 + sm6 + sm7 + sm8 + sm9 + sm10 + sm11 + sm12 + sm13 + sm14 + sm15 + sm16 + sm17 + sm18" 

soc_ic_model <- "IC =~ soc_ic1 + soc_ic2 + soc_ic3 + soc_ic4 + soc_ic5 + soc_ic6 + soc_ic7 + soc_ic8 + soc_ic9" 
soc_pe_model <- "PE =~ soc_pe1 + soc_pe2 + soc_pe3 + soc_pe4 + soc_pe5 + soc_pe6 + soc_pe7 + soc_pe8 + soc_pe9 + soc_pe10" 


# full scales
bidr_model <- "IM =~ bidr_im1 + bidr_im2 + bidr_im3 + bidr_im4 + bidr_im5 + bidr_im6 + bidr_im7 + bidr_im8 + bidr_im9 + 
                     bidr_im10 + bidr_im11 + bidr_im12 + bidr_im13 + bidr_im14 + bidr_im15 + bidr_im16 + bidr_im17 + bidr_im18
               SDE =~ bidr_sde1 + bidr_sde2 + bidr_sde3 + bidr_sde4 + bidr_sde5 + bidr_sde6 + bidr_sde7 + bidr_sde8 + bidr_sde9 + 
                      bidr_sde10 + bidr_sde11 + bidr_sde12 + bidr_sde13 + bidr_sde14 + bidr_sde15 + bidr_sde16 + bidr_sde17 + bidr_sde18" 

icat_model <- "ICAT_O =~ icat_o1 + icat_o2 + icat_o3 + icat_o4 + icat_o5 + icat_o6 + icat_o7 + icat_o8 + icat_o9
               ICAT_S =~ icat_s1 + icat_s2 + icat_s3 + icat_s4 + icat_s5 + icat_s6 + icat_s7 + icat_s8 + icat_s9" 

nfcc_model <- "P =~ nfcc_p1 + nfcc_p2 + nfcc_p3 + nfcc_p4 + nfcc_p5 + nfcc_p6 + nfcc_p7 + nfcc_p8
               D =~ nfcc_d1 + nfcc_d2 + nfcc_d3 + nfcc_d4 + nfcc_d5 + nfcc_d6 + nfcc_d7
               C =~ nfcc_c1 + nfcc_c2 + nfcc_c3 + nfcc_c4 + nfcc_c5 + nfcc_c6 + nfcc_c7 + nfcc_c8
               A =~ nfcc_a1 + nfcc_a2 + nfcc_a3 + nfcc_a4 + nfcc_a5 + nfcc_a6 + nfcc_a7 + nfcc_a8
               O =~ nfcc_o1 + nfcc_o2 + nfcc_o3 + nfcc_o4 + nfcc_o5 + nfcc_o6 + nfcc_o7" 

soc_model <- "IC =~ soc_ic1 + soc_ic2 + soc_ic3 + soc_ic4 + soc_ic5 + soc_ic6 + soc_ic7 + soc_ic8 + soc_ic9
              PE =~ soc_pe1 + soc_pe2 + soc_pe3 + soc_pe4 + soc_pe5 + soc_pe6 + soc_pe7 + soc_pe8 + soc_pe9 + soc_pe10" 

```

# Demographics

```{r}

trimmed_data %>%
  count() %>%
  rename(`N unique experimental sessions` = n) %>%
  kable() %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

trimmed_data %>%
  select(user_id, session_id) %>%
  group_by(user_id) %>%
  summarize(n = n()) %>%
  summarize(mean_sessions = mean(n),
            median_sessions = median(n),
            sd_sessions = sd(n)) %>%
  round_df(2) %>%
  gather() %>%
  kable() %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

demographics_temp <- trimmed_first_timepoint_per_user_per_scale %>%
  mutate(sex = recode(sex,
                      "f" = 1,
                      "m" = 2)) %>%
  group_by(user_id) %>%
  # given repeat presentations
  summarize(mean_age_across_participations = mean(age),
            sex = mean(sex)) %>%
  ungroup() %>%
  mutate(sex = recode(sex,
                      "1" = "f",
                      "2" = "m"))

demographics_temp %>%
  count() %>%
  rename(`N unique participants` = n) %>%
  kable() %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

demographics_temp %>%
  count(sex) %>%
  kable() %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

demographics_temp %>%
  summarise(age_mean = mean(mean_age_across_participations),
            age_median = median(mean_age_across_participations),
            age_sd = sd(mean_age_across_participations)) %>%
  round_df(2) %>%
  gather() %>%
  kable() %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

```

# Structural validity analyses

## Distributions

```{r}

# scales
ggplot(trimmed_first_timepoint_per_user_per_scale) + 
  geom_density(aes(individual_differences_sum_score)) +
  facet_wrap(~individual_differences_measure, scales = "free")

# subscales where applicable
trimmed_first_timepoint_per_user_per_scale %>%
  select(session_id, 
         BFI_E_subscale, BFI_C_subscale, BFI_N_subscale, BFI_A_subscale, BFI_O_subscale, 
         NFCC_P_subscale, NFCC_D_subscale, NFCC_C_subscale, NFCC_O_subscale, NFCC_A_subscale) %>%
  gather(key = subscale, value = score, c(BFI_E_subscale, BFI_C_subscale, BFI_N_subscale, BFI_A_subscale, BFI_O_subscale, 
                                          NFCC_P_subscale, NFCC_D_subscale, NFCC_C_subscale, NFCC_O_subscale, NFCC_A_subscale)) %>%
  na.omit() %>%
  ggplot() + 
  geom_density(aes(score)) +
  facet_wrap(~subscale, scales = "free")

```

```{r}

## distribution info
distributions_auto <- function(data, scale_name) {
  require(moments)
  require(plotrix)
  data %>%
    mutate(sum = rowSums(.)) %>%
    dplyr::select(sum) %>%
    summarize(M = round(mean(sum, na.rm = TRUE), 2),
              SE = round(std.error(sum, na.rm = TRUE), 2),
              SD = round(sd(sum, na.rm = TRUE), 2),
              Skewness = round(skewness(sum), 2),
              Kurtosis = round(kurtosis(sum), 2)) %>%
    mutate(Scale = scale_name)
}

# split scales
bfi_e_dist    <- bfi_e_data    %>% dplyr::select(-age, -sex) %>% distributions_auto(., scale_name = "Big 5 Inventory - E")
bfi_c_dist    <- bfi_c_data    %>% dplyr::select(-age, -sex) %>% distributions_auto(., scale_name = "Big 5 Inventory - C")
bfi_n_dist    <- bfi_n_data    %>% dplyr::select(-age, -sex) %>% distributions_auto(., scale_name = "Big 5 Inventory - N")
bfi_a_dist    <- bfi_a_data    %>% dplyr::select(-age, -sex) %>% distributions_auto(., scale_name = "Big 5 Inventory - A")
bfi_o_dist    <- bfi_o_data    %>% dplyr::select(-age, -sex) %>% distributions_auto(., scale_name = "Big 5 Inventory - O")
bidr_im_dist  <- bidr_im_data  %>% dplyr::select(-age, -sex) %>% distributions_auto(., scale_name = "Balanced Inventory of Desirable Responding - Impression Management")
bidr_sde_dist <- bidr_sde_data %>% dplyr::select(-age, -sex) %>% distributions_auto(., scale_name = "Balanced Inventory of Desirable Responding - Self Deception")
bjw_dist      <- bjw_data      %>% dplyr::select(-age, -sex) %>% distributions_auto(., scale_name = "Belief in a Just World")
brs_dist      <- brs_data      %>% dplyr::select(-age, -sex) %>% distributions_auto(., scale_name = "Bayesian Racism")
he_dist       <- he_data       %>% dplyr::select(-age, -sex) %>% distributions_auto(., scale_name = "Humanitarianism-Egalitarianism")
icat_o_dist   <- icat_o_data   %>% dplyr::select(-age, -sex) %>% distributions_auto(., scale_name = "Intuitions about Controllability and Awareness of Thoughts - Others")
icat_s_dist   <- icat_s_data   %>% dplyr::select(-age, -sex) %>% distributions_auto(., scale_name = "Intuitions about Controllability and Awareness of Thoughts - Self")
nfc_dist      <- nfc_data      %>% dplyr::select(-age, -sex) %>% distributions_auto(., scale_name = "Need for Cognition")
nfcc_ao_dist  <- nfcc_ao_data  %>% dplyr::select(-age, -sex) %>% distributions_auto(., scale_name = "Need for Cognitive Closure - P")
nfcc_pdc_dist <- nfcc_pdc_data %>% dplyr::select(-age, -sex) %>% distributions_auto(., scale_name = "Need for Cognitive Closure - O")
pe_dist       <- pe_data       %>% dplyr::select(-age, -sex) %>% distributions_auto(., scale_name = "Protestant Ethic")
pns_dist      <- pns_data      %>% dplyr::select(-age, -sex) %>% distributions_auto(., scale_name = "Personal Need for Structure")
rse_dist      <- rse_data      %>% dplyr::select(-age, -sex) %>% distributions_auto(., scale_name = "Rosenberg Self-Esteem")
rwa_dist      <- rwa_data      %>% dplyr::select(-age, -sex) %>% distributions_auto(., scale_name = "Ring-Wing Authoritarianism")
sdo_dist      <- sdo_data      %>% dplyr::select(-age, -sex) %>% distributions_auto(., scale_name = "Social Dominance Orientation")
sm_dist       <- sm_data       %>% dplyr::select(-age, -sex) %>% distributions_auto(., scale_name = "Self-Monitoring")
soc_ic_dist   <- soc_ic_data   %>% dplyr::select(-age, -sex) %>% distributions_auto(., scale_name = "Spheres of Control - Interpersonal Control")
soc_pe_dist   <- soc_pe_data   %>% dplyr::select(-age, -sex) %>% distributions_auto(., scale_name = "Spheres of Control - Personal Efficacy")

# full scales
bidr_dist    <- bidr_data  %>% dplyr::select(-age, -sex) %>% distributions_auto(., scale_name = "Balanced Inventory of Desirable Responding")
icat_dist    <- icat_data  %>% dplyr::select(-age, -sex) %>% distributions_auto(., scale_name = "Intuitions about Controllability and Awareness of Thoughts")
nfcc_dist    <- nfcc_data  %>% dplyr::select(-age, -sex) %>% distributions_auto(., scale_name = "Need for Cognitive Closure")
soc_dist     <- soc_data   %>% dplyr::select(-age, -sex) %>% distributions_auto(., scale_name = "Spheres of Control")

dist_results <- rbind(bfi_e_dist, bfi_c_dist, bfi_n_dist, bfi_a_dist, bfi_o_dist,
                      bidr_im_dist, bidr_sde_dist, bjw_dist, brs_dist,
                      he_dist, icat_o_dist, icat_s_dist, nfc_dist, nfcc_ao_dist, nfcc_pdc_dist,
                      pe_dist, pns_dist, rse_dist, rwa_dist, sdo_dist, sm_dist, soc_ic_dist, soc_pe_dist,
                      bidr_dist, icat_dist, nfcc_dist, soc_dist)

# remove redundant objects to keep the environment tidy
rm(bfi_e_dist, bfi_c_dist, bfi_n_dist, bfi_a_dist, bfi_o_dist,
   bidr_im_dist, bidr_sde_dist, bjw_dist, brs_dist,
   he_dist, icat_o_dist, icat_s_dist, nfc_dist, nfcc_ao_dist, nfcc_pdc_dist,
   pe_dist, pns_dist, rse_dist, rwa_dist, sdo_dist, sm_dist, soc_ic_dist, soc_pe_dist,
                      bidr_dist, icat_dist, nfcc_dist, soc_dist)

```

## Internal consistency

```{r}

# needed for both consistency and cfa analyses
fit_cfa <- function(data, model) {
  require(lavaan)
  require(tidyverse)

  data %>%
    dplyr::select(-sex, -age) %>%
    cfa(model,
        data = .,
        order = c("1", "2", "3", "4", "5", "6"),
        estimator = "WLSMV")  # can notionally change this to Maximum Likelihood (ML) but produces worse fits across measures
}

```


```{r}

# # NB Bootstrapping of the CIs takes time (30+ mins), so the results have been saved to disk to save others time. Uncomment the below code to redo the bootstrapping.


# n_boots <- 1000
# 
# # NB the below code isn't as elegant as I'd like, but works just fine. `model` should be passed as an argument among the three nested functions, but I couldn't work out how to get purrr::map() to take an argument for the function it applies to the bootstraps. Instead, model is defined as a global variable before each estimate_reliability() call. This is fine statistically, but represents bad coding (undesirable variable scoping). Plz don't post me to /r/badcode. 
# 
# 
# # helper function
# bootstrap_reliability_helper <- function(split, ...) {
#   
#   require(lavaan)
#   require(semTools)
#   require(tidyverse)
#   
#   fit_cfa(analysis(split), model) %>%
#     reliability() %>%
#     as.data.frame() %>%
#     rownames_to_column(var = "metric") %>%
#     select(metric, total) %>%
#     filter(metric %in% c("alpha", 
#                          "omega2", 
#                          "omega3")) %>%
#     mutate(metric = recode(metric,
#                            "alpha" = "alpha", 
#                            "omega2" = "omega_t",
#                            "omega3" = "omega_h")) 
#   
# }
# 
# # apply bootstrapping, then extract coefficients via percentile method
# estimate_reliability <- function(data, scale, ...) {
#   
#   require(purrr)
#   require(rsample)
#   require(tidyverse)
#   require(timesavers)
#   
#   # create bootstraps using out of bag method. makes a df with values that are collapsed dfs.
#   boot_samples <- data %>%
#     bootstraps(., times = n_boots) 
#   
#   # apply to each bootstrap
#   boots <- boot_samples %>% 
#     mutate(reliability_results = map(splits, bootstrap_reliability_helper)) %>% 
#     unnest(reliability_results)
#   
#   # find CIs using percentile method
#   boot_estimates <- boots %>% 
#     group_by(metric) %>%
#     summarize(median   = quantile(total, 0.500),
#               ci_lower = quantile(total, 0.025),
#               ci_upper = quantile(total, 0.975)) %>%
#     round_df(3) %>%
#     mutate(Scale = scale)
#   
#   return(boot_estimates)
# }
# 
# # split scales
# model <- bfi_e_model
# consistency_bfi_e    <- estimate_reliability(bfi_e_data,    "Big 5 Inventory - E")
# 
# model <- bfi_c_model
# consistency_bfi_c    <- estimate_reliability(bfi_c_data,    "Big 5 Inventory - C")
# 
# model <- bfi_n_model
# consistency_bfi_n    <- estimate_reliability(bfi_n_data,    "Big 5 Inventory - N")
# 
# model <- bfi_a_model
# consistency_bfi_a    <- estimate_reliability(bfi_a_data,    "Big 5 Inventory - A")
# 
# model <- bfi_o_model
# consistency_bfi_o    <- estimate_reliability(bfi_o_data,    "Big 5 Inventory - O")
# 
# model <- bidr_im_model
# consistency_bidr_im  <- estimate_reliability(bidr_im_data,  "Balanced Inventory of Desirable Responding - Impression Management")
# 
# model <- bidr_sde_model
# consistency_bidr_sde <- estimate_reliability(bidr_sde_data, "Balanced Inventory of Desirable Responding - Self Deception")
# 
# model <- bjw_model
# consistency_bjw      <- estimate_reliability(bjw_data,      "Belief in a Just World: General Just World Scale")
# 
# model <- brs_model
# consistency_brs      <- estimate_reliability(brs_data,      "Bayesian Racism")
# 
# model <- he_model
# consistency_he       <- estimate_reliability(he_data,       "Humanitarianism-Egalitarianism")
# 
# model <- icat_o_model
# consistency_icat_o   <- estimate_reliability(icat_o_data,   "Intuitions about Controllability and Awareness of Thoughts - Others")
# 
# model <- icat_s_model
# consistency_icat_s   <- estimate_reliability(icat_s_data,   "Intuitions about Controllability and Awareness of Thoughts - Self")
# 
# model <- nfc_model
# consistency_nfc      <- estimate_reliability(nfc_data,      "Need for Cognition")
# 
# model <- nfcc_ao_model
# consistency_nfcc_ao  <- estimate_reliability(nfcc_ao_data,  "Need for Cognitive Closure - O,A")
# 
# model <- nfcc_pdc_model
# consistency_nfcc_pdc <- estimate_reliability(nfcc_pdc_data, "Need for Cognitive Closure - P,D,CM")
# 
# model <- pe_model
# consistency_pe       <- estimate_reliability(pe_data,       "Protestant Ethic")
# 
# model <- pns_model
# consistency_pns      <- estimate_reliability(pns_data,      "Personal Need for Structure")
# 
# model <- rse_model
# consistency_rse      <- estimate_reliability(rse_data,      "Rosenberg Self-Esteem")
# 
# model <- rwa_model
# consistency_rwa      <- estimate_reliability(rwa_data,      "Ring-Wing Authoritarianism")
# 
# model <- sdo_model
# consistency_sdo      <- estimate_reliability(sdo_data,      "Social Dominance Orientation")
# 
# model <- sm_model
# consistency_sm       <- estimate_reliability(sm_data,       "Self-Monitoring")
# 
# model <- soc_ic_model
# consistency_soc_ic   <- estimate_reliability(soc_ic_data,   "Spheres of Control - Interpersonal Control")
# 
# model <- soc_pe_model
# consistency_soc_pe   <- estimate_reliability(soc_pe_data,   "Spheres of Control - Personal Efficacy")
# 
# # full scales
# model <- bidr_model
# consistency_bidr     <- estimate_reliability(bidr_data,     "Balanced Inventory of Desirable Responding")
# 
# model <- icat_model
# consistency_icat     <- estimate_reliability(icat_data,     "Intuitions about Controllability and Awareness of Thoughts")
# 
# model <- nfcc_model
# consistency_nfcc     <- estimate_reliability(nfcc_data,     "Need for Cognitive Closure")
# 
# model <- soc_model
# consistency_soc      <- estimate_reliability(soc_data,      "Spheres of Control")
# 
# 
# consistency_estimates_temp <- bind_rows(consistency_bfi_e,
#                                         consistency_bfi_c,
#                                         consistency_bfi_n,
#                                         consistency_bfi_a,
#                                         consistency_bfi_o,
#                                         consistency_bidr_im,
#                                         consistency_bidr_sde,
#                                         consistency_bjw,
#                                         consistency_brs,
#                                         consistency_he,
#                                         consistency_icat_o,
#                                         consistency_icat_s,
#                                         consistency_nfc,
#                                         consistency_nfcc_ao,
#                                         consistency_nfcc_pdc,
#                                         consistency_pe,
#                                         consistency_pns,
#                                         consistency_rse,
#                                         consistency_rwa,
#                                         consistency_sdo,
#                                         consistency_sm,
#                                         consistency_soc_ic,
#                                         consistency_soc_pe,
#                                         consistency_bidr,
#                                         consistency_icat,
#                                         consistency_nfcc,
#                                         consistency_soc)
# 
# consistency_estimates_alpha <- consistency_estimates_temp %>%
#   filter(metric == "alpha") %>%
#   select(-metric) %>%
#   rename(alpha = median,
#          alpha_ci_lower = ci_lower,
#          alpha_ci_upper = ci_upper)
# 
# consistency_estimates_omega_t <- consistency_estimates_temp %>%
#   filter(metric == "omega_t") %>%
#   select(-metric) %>%
#   rename(omega_t = median,
#          omega_t_ci_lower = ci_lower,
#          omega_t_ci_upper = ci_upper)
# 
# consistency_estimates_omega_h <- consistency_estimates_temp %>%
#   filter(metric == "omega_h") %>%
#   select(-metric) %>%
#   rename(omega_h = median,
#          omega_h_ci_lower = ci_lower,
#          omega_h_ci_upper = ci_upper)
# 
# consistency_results <- consistency_estimates_alpha %>%
#   left_join(consistency_estimates_omega_t, by = "Scale") %>%
#   left_join(consistency_estimates_omega_h, by = "Scale")
# 
# # remove redundant objects to keep the environment tidy
# rm(consistency_estimates_alpha, consistency_estimates_omega_t, consistency_estimates_omega_h, 
#    consistency_bfi_e, consistency_bfi_c, consistency_bfi_n, consistency_bfi_a, 
#    consistency_bfi_o, consistency_bidr_im, consistency_bidr_sde, consistency_bjw, consistency_brs, consistency_he,
#    consistency_icat_o, consistency_icat_s, consistency_nfc, consistency_nfcc_ao, consistency_nfcc_pdc, consistency_pe,
#    consistency_pns, consistency_rse, consistency_rwa, consistency_sdo, consistency_sm, consistency_soc_ic, 
#    consistency_soc_pe, consistency_bidr, consistency_icat, consistency_nfcc, consistency_soc)

```

```{r}
#save(consistency_results, file = "results/consistency_results.RData")
load("results/consistency_results.RData")
```

## Test-retest reliability

### Dependability

Split scales only

```{r}

dependability_data <- two_timepoint_scores %>%
  filter(days_to_followup < 1/24)  # retest within an hour

# n per scale
n_per_scale_dependability <- user_ids_with_two_timepoints_per_scale %>%
  # scale names differ between two data frames; hack a solution
  mutate(individual_differences_measure = ifelse(as.character(individual_differences_measure) == "BFI-Part 1", "BFI_E", 
                                                 ifelse(as.character(individual_differences_measure) == "BFI-Part 2", "BFI_A", 
                                                        as.character(individual_differences_measure)))) %>%
  semi_join(dependability_data, by = c("user_id", "individual_differences_measure")) %>%
  count(individual_differences_measure) %>%
  rename(Scale = individual_differences_measure,
         `Test-retest dependability n` = n)

pearson_r_estimate <- function(data, Scale){
  require(tidyverse)
  require(psych)
  
  res <- data %>%
    filter(individual_differences_measure == Scale) %>%
    select(individual_differences_sum_score_t1, individual_differences_sum_score_t2) %>%
    cor.ci(n.iter = 1000, method = "pearson", plot = FALSE)
  
  results <-
    data.frame(Scale = Scale,
               pearson_r = res$means,
               pearson_r_ci_lwr = res$ci$low.e,
               pearson_r_ci_upr = res$ci$up.e) %>%
    round_df(3)
  
  return(results)
}

test_retest_dependability <-
  rbind(pearson_r_estimate(data = dependability_data, Scale = "BFI_E"),
        pearson_r_estimate(data = dependability_data, Scale = "BFI_C"),
        pearson_r_estimate(data = dependability_data, Scale = "BFI_N"),
        pearson_r_estimate(data = dependability_data, Scale = "BFI_A"),
        pearson_r_estimate(data = dependability_data, Scale = "BFI_O"),
        pearson_r_estimate(data = dependability_data, Scale = "BIDR-IM"),
        pearson_r_estimate(data = dependability_data, Scale = "BIDR-SDE"),
        pearson_r_estimate(data = dependability_data, Scale = "BJW"),
        pearson_r_estimate(data = dependability_data, Scale = "BRS"),
        pearson_r_estimate(data = dependability_data, Scale = "HE"),
        pearson_r_estimate(data = dependability_data, Scale = "ICAT-O"),
        pearson_r_estimate(data = dependability_data, Scale = "ICAT-S"),
        pearson_r_estimate(data = dependability_data, Scale = "NFC"),
        pearson_r_estimate(data = dependability_data, Scale = "NFCC, Part 1"),
        pearson_r_estimate(data = dependability_data, Scale = "NFCC, Part 2"),
        pearson_r_estimate(data = dependability_data, Scale = "PE"),
        pearson_r_estimate(data = dependability_data, Scale = "PNS"),
        pearson_r_estimate(data = dependability_data, Scale = "RSE"),
        pearson_r_estimate(data = dependability_data, Scale = "RWA"),
        pearson_r_estimate(data = dependability_data, Scale = "SDO"),
        pearson_r_estimate(data = dependability_data, Scale = "SM"),
        pearson_r_estimate(data = dependability_data, Scale = "SOC-IC"),
        pearson_r_estimate(data = dependability_data, Scale = "SOC-PE")) %>%
  rename(`Test-retest dependability r` = pearson_r,
         `dependability r lower` = pearson_r_ci_lwr,
         `dependability r upper` = pearson_r_ci_upr)

# combine and tidy
dependability_results <- test_retest_dependability %>%
  full_join(n_per_scale_dependability, by = "Scale") %>%
  # hacky solution to populate the BFI1 and BFI2 Ns into all cells
  mutate(`Test-retest dependability n` = ifelse(Scale == "BFI_C", lag(`Test-retest dependability n`), `Test-retest dependability n`),
         `Test-retest dependability n` = ifelse(Scale == "BFI_N", lag(`Test-retest dependability n`), `Test-retest dependability n`),
         `Test-retest dependability n` = ifelse(Scale == "BFI_O", lag(`Test-retest dependability n`), `Test-retest dependability n`)) %>%
  mutate(Scale = dplyr::recode(Scale,
                               "BFI_E"    = "Big 5 Inventory - E",
                               "BFI_C"    = "Big 5 Inventory - C",
                               "BFI_N"    = "Big 5 Inventory - N",
                               "BFI_A"    = "Big 5 Inventory - A",
                               "BFI_O"    = "Big 5 Inventory - O",
                               "BIDR-IM"  = "Balanced Inventory of Desirable Responding - Impression Management",
                               "BIDR-SDE" = "Balanced Inventory of Desirable Responding - Self Deception",
                               "BJW"      = "Belief in a Just World: General Just World Scale",
                               "BRS"      = "Bayesian Racism",
                               "HE"       = "Humanitarianism-Egalitarianism",
                               "ICAT-O"   = "Intuitions about Controllability and Awareness of Thoughts - Others",
                               "ICAT-S"   = "Intuitions about Controllability and Awareness of Thoughts - Self",
                               "NFC"      = "Need for Cognition",
                               "NFCC, Part 1"  = "Need for Cognitive Closure - P,D,CM",
                               "NFCC, Part 2"  = "Need for Cognitive Closure - O,A",
                               "PE"       = "Protestant Ethic",
                               "PNS"      = "Personal Need for Structure",
                               "RSE"      = "Rosenberg Self-Esteem",
                               "RWA"      = "Ring-Wing Authoritarianism",
                               "SDO"      = "Social Dominance Orientation",
                               "SM"       = "Self-Monitoring",
                               "SOC-IC"   = "Spheres of Control - Interpersonal Control",
                               "SOC-PE"   = "Spheres of Control - Personal Efficacy"))

```

### Stability

Split scales only

```{r}

stability_data <- two_timepoint_scores %>%
  filter(days_to_followup >= 1 & days_to_followup < 365)  # retest more than a day and less than a year later

# n per scale
n_per_scale_stability <- user_ids_with_two_timepoints_per_scale %>%
  # scale names differ between two data frames; hack a solution
  mutate(individual_differences_measure = ifelse(as.character(individual_differences_measure) == "BFI-Part 1", "BFI_E", 
                                                 ifelse(as.character(individual_differences_measure) == "BFI-Part 2", "BFI_A", 
                                                        as.character(individual_differences_measure)))) %>%
  semi_join(stability_data, by = c("user_id", "individual_differences_measure")) %>%
  count(individual_differences_measure) %>%
  rename(Scale = individual_differences_measure,
         `Test-retest stability n` = n)

test_retest_stability <-
  rbind(pearson_r_estimate(data = stability_data, Scale = "BFI_E"),
        pearson_r_estimate(data = stability_data, Scale = "BFI_C"),
        pearson_r_estimate(data = stability_data, Scale = "BFI_N"),
        pearson_r_estimate(data = stability_data, Scale = "BFI_A"),
        pearson_r_estimate(data = stability_data, Scale = "BFI_O"),
        pearson_r_estimate(data = stability_data, Scale = "BIDR-IM"),
        pearson_r_estimate(data = stability_data, Scale = "BIDR-SDE"),
        pearson_r_estimate(data = stability_data, Scale = "BJW"),
        pearson_r_estimate(data = stability_data, Scale = "BRS"),
        pearson_r_estimate(data = stability_data, Scale = "HE"),
        pearson_r_estimate(data = stability_data, Scale = "ICAT-O"),
        pearson_r_estimate(data = stability_data, Scale = "ICAT-S"),
        pearson_r_estimate(data = stability_data, Scale = "NFC"),
        pearson_r_estimate(data = stability_data, Scale = "NFCC, Part 1"),
        pearson_r_estimate(data = stability_data, Scale = "NFCC, Part 2"),
        pearson_r_estimate(data = stability_data, Scale = "PE"),
        pearson_r_estimate(data = stability_data, Scale = "PNS"),
        pearson_r_estimate(data = stability_data, Scale = "RSE"),
        pearson_r_estimate(data = stability_data, Scale = "RWA"),
        pearson_r_estimate(data = stability_data, Scale = "SDO"),
        pearson_r_estimate(data = stability_data, Scale = "SM"),
        pearson_r_estimate(data = stability_data, Scale = "SOC-IC"),
        pearson_r_estimate(data = stability_data, Scale = "SOC-PE")) %>%
  rename(`Test-retest stability r` = pearson_r,
         `stability r lower` = pearson_r_ci_lwr,
         `stability r upper` = pearson_r_ci_upr)

# combine and tidy
stability_results <- test_retest_stability %>%
  full_join(n_per_scale_stability, by = "Scale") %>%
  # hacky solution to populate the BFI1 and BFI2 Ns into all cells
  mutate(`Test-retest stability n` = ifelse(Scale == "BFI_C", lag(`Test-retest stability n`), `Test-retest stability n`),
         `Test-retest stability n` = ifelse(Scale == "BFI_N", lag(`Test-retest stability n`), `Test-retest stability n`),
         `Test-retest stability n` = ifelse(Scale == "BFI_O", lag(`Test-retest stability n`), `Test-retest stability n`)) %>%
  mutate(Scale = dplyr::recode(Scale,
                               "BFI_E"    = "Big 5 Inventory - E",
                               "BFI_C"    = "Big 5 Inventory - C",
                               "BFI_N"    = "Big 5 Inventory - N",
                               "BFI_A"    = "Big 5 Inventory - A",
                               "BFI_O"    = "Big 5 Inventory - O",
                               "BIDR-IM"  = "Balanced Inventory of Desirable Responding - Impression Management",
                               "BIDR-SDE" = "Balanced Inventory of Desirable Responding - Self Deception",
                               "BJW"      = "Belief in a Just World: General Just World Scale",
                               "BRS"      = "Bayesian Racism",
                               "HE"       = "Humanitarianism-Egalitarianism",
                               "ICAT-O"   = "Intuitions about Controllability and Awareness of Thoughts - Others",
                               "ICAT-S"   = "Intuitions about Controllability and Awareness of Thoughts - Self",
                               "NFC"      = "Need for Cognition",
                               "NFCC, Part 1"  = "Need for Cognitive Closure - P,D,CM",
                               "NFCC, Part 2"  = "Need for Cognitive Closure - O,A",
                               "PE"       = "Protestant Ethic",
                               "PNS"      = "Personal Need for Structure",
                               "RSE"      = "Rosenberg Self-Esteem",
                               "RWA"      = "Ring-Wing Authoritarianism",
                               "SDO"      = "Social Dominance Orientation",
                               "SM"       = "Self-Monitoring",
                               "SOC-IC"   = "Spheres of Control - Interpersonal Control",
                               "SOC-PE"   = "Spheres of Control - Personal Efficacy"))

```

## CFA fits

```{r}

## fit a CFA and return its model fit statistics
cfa_fit_metrics <- function(fit, scale) {
  
  require(lavaan)
  require(tidyverse)
  
  # fit statistics
  fit_stats <- data.frame(estimate = fitMeasures(fit)) %>%
    rownames_to_column(var = "metric") %>%
    filter(metric %in% c("chisq", "df", "pvalue", "srmr", "rmsea", "rmsea.ci.lower", "rmsea.ci.upper", "cfi", "tli")) %>%
    spread(metric, estimate) %>%
    mutate(Scale = scale,
           pvalue = ifelse(pvalue < .0001, "< .0001", as.character(round(pvalue, 4))),
           "chisq/df"  = round(chisq/df, 1),
           cfa_test = ifelse(srmr <= .09 & cfi >= .95 & tli >= .95 & rmsea <= .06, "Good",
                                ifelse(srmr <= .09 & (cfi >= .95 | tli >= .95 | rmsea <= .06), "Mixed", "Poor")),
           cfa_test = fct_relevel(cfa_test, "Good", "Mixed", "Poor"))
    
  return(fit_stats)
}

cfi_fit_results <- 
  bind_rows(cfa_fit_metrics(fit_cfa(bfi_e_data,    bfi_e_model),    scale = "Big 5 Inventory - E"),
            cfa_fit_metrics(fit_cfa(bfi_c_data,    bfi_c_model),    scale = "Big 5 Inventory - C"),
            cfa_fit_metrics(fit_cfa(bfi_n_data,    bfi_n_model),    scale = "Big 5 Inventory - N"),
            cfa_fit_metrics(fit_cfa(bfi_a_data,    bfi_a_model),    scale = "Big 5 Inventory - A"),
            cfa_fit_metrics(fit_cfa(bfi_o_data,    bfi_o_model),    scale = "Big 5 Inventory - O"),
            cfa_fit_metrics(fit_cfa(bidr_im_data,  bidr_im_model),  scale = "Balanced Inventory of Desirable Responding - Impression Management"),
            cfa_fit_metrics(fit_cfa(bidr_sde_data, bidr_sde_model), scale = "Balanced Inventory of Desirable Responding - Self Deception"),
            cfa_fit_metrics(fit_cfa(bjw_data,      bjw_model),      scale = "Belief in a Just World: General Just World Scale"),
            cfa_fit_metrics(fit_cfa(brs_data,      brs_model),      scale = "Bayesian Racism"),
            cfa_fit_metrics(fit_cfa(he_data,       he_model),       scale = "Humanitarianism-Egalitarianism"),
            cfa_fit_metrics(fit_cfa(icat_o_data,   icat_o_model),   scale = "Intuitions about Controllability and Awareness of Thoughts - Others"),
            cfa_fit_metrics(fit_cfa(icat_s_data,   icat_s_model),   scale = "Intuitions about Controllability and Awareness of Thoughts - Self"),
            cfa_fit_metrics(fit_cfa(nfc_data,      nfc_model),      scale = "Need for Cognition"),
            cfa_fit_metrics(fit_cfa(nfcc_ao_data,  nfcc_ao_model),  scale = "Need for Cognitive Closure - P,D,CM"),
            cfa_fit_metrics(fit_cfa(nfcc_pdc_data, nfcc_pdc_model), scale = "Need for Cognitive Closure - O,A"),
            cfa_fit_metrics(fit_cfa(pe_data,       pe_model),       scale = "Protestant Ethic"),
            cfa_fit_metrics(fit_cfa(pns_data,      pns_model),      scale = "Personal Need for Structure"),
            cfa_fit_metrics(fit_cfa(rse_data,      rse_model),      scale = "Rosenberg Self-Esteem"),
            cfa_fit_metrics(fit_cfa(rwa_data,      rwa_model),      scale = "Ring-Wing Authoritarianism"),
            cfa_fit_metrics(fit_cfa(sdo_data,      sdo_model),      scale = "Social Dominance Orientation"),
            cfa_fit_metrics(fit_cfa(sm_data,       sm_model),       scale = "Self-Monitoring"),
            cfa_fit_metrics(fit_cfa(soc_ic_data,   soc_ic_model),   scale = "Spheres of Control - Interpersonal Control"),
            cfa_fit_metrics(fit_cfa(soc_pe_data,   soc_pe_model),   scale = "Spheres of Control - Personal Efficacy"),
            # full scales
            cfa_fit_metrics(fit_cfa(bidr_data,     bidr_model),     scale = "Balanced Inventory of Desirable Responding"),
            cfa_fit_metrics(fit_cfa(icat_data,     icat_model),     scale = "Intuitions about Controllability and Awareness of Thoughts"),
            cfa_fit_metrics(fit_cfa(nfcc_data,     nfcc_model),     scale = "Need for Cognitive Closure"),
            cfa_fit_metrics(fit_cfa(soc_data,      soc_model),      scale = "Spheres of Control")) %>%
  round_df(3) %>%
  # join other scale data in
  left_join(n_per_scale_with_bfi_subscales, by = "Scale") %>% 
  left_join(additional_scale_data, by = "Scale")

```

## Measurement Invariance

Between groups: gender and median age. 

Tests of measurement invariance (configural, metric, and scalar) using the cutoffs on the change in goodness-of-fit indices rather than a likelihood ratio test, which is highly senstive to sample size (Cheung & Rensvold, 2002). Cutoffs for configural invariance provided by Hu and Bentler (1999: same criteria as CFA fits above) and for metric and scalar invariance provided by Cheung & Rensvold (2002: Î”RMSEA <= 0.01 & Î”CLI <= -0.015; see also Chen, 2007 for very similar reccomendations). MI tests are conducted using the same methods as the CFAs: by assuming data is ordinal (e.g., likert data) using the distribution free DWLS estimator plus robust effect size estimates (i.e., estimator = "WLSMV").

```{r include=FALSE}

# i originally used semTools::measurementInvarianceCat() but it gave convergence issues with many models. it is also now depreciated. the following post suggested this has been observed before (https://groups.google.com/forum/#!topic/lavaan/aGCVepFrcCs). to maintain a uniform strategy across all scales, i changed to a manual CFA contraint strategy below.

mi_via_cutoffs <- function(data, model, scale, group) {
  
  # dependencies
  require(lavaan)
  require(tidyverse)
  require(semTools)
  require(timesavers)
  
  # fit the configural model 
  fit_configural <- data %>%
    cfa(model = model,
        data  = .,
        order = c("1", "2", "3", "4", "5", "6"),
        estimator = "WLSMV",
        group = group)
  
  # constrain slopes
  fit_metric <- data %>%
    cfa(model = model,
        data  = .,
        order = c("1", "2", "3", "4", "5", "6"),
        estimator = "WLSMV",
        group = group,
        group.equal = "loadings")
  
  # constrain intercepts
  fit_scalar <- data %>%
    cfa(model = model,
        data  = .,
        order = c("1", "2", "3", "4", "5", "6"),
        estimator = "WLSMV",
        group = group,
        group.equal = c( "loadings", "intercepts"))
  
  # summarize these cfa fit indices, and their change across nested models
  results <- compareFit(fit_configural, fit_metric, fit_scalar, nested = TRUE) %>%
    summary()
  
  fit_indices <- results$fit.indices %>%
    rownames_to_column(var = "test") %>%
    mutate(MI_config = ifelse(srmr <= .09 & cfi.scaled >= .95 & tli.scaled >= .95 & rmsea.scaled <= .06, "Good",
                              ifelse(srmr <= .09 & (cfi.scaled >= .95 | tli.scaled >= .95 | rmsea.scaled <= .06), "Mixed", "Poor")),
           MI_config = ifelse(test == "fit_configural", MI_config, NA),
           pvalue.scaled = as.character(ifelse(pvalue.scaled < .0001, "< .0001", round(pvalue.scaled, 4)))) %>%
    round_df(3) %>%
    mutate(Scale = scale,
           group = group)
  
  fit_deltas <- results$fit.diff %>%
    rownames_to_column(var = "test") %>%
    mutate(MI_delta = ifelse(rmsea.scaled > 0.01 | cfi.scaled < -0.015, "Failed", "Passed")) %>%
    round_df(3) %>%
    mutate(Scale = scale,
           group = group)
  
  # return results as a list of data frames, including the fitted models
  return(list(fit_indices    = fit_indices,
              fit_deltas     = fit_deltas))
  
}

# mi for gender
# split scales
MI_sex_bfi_e    <- mi_via_cutoffs(data = bfi_e_data,    model = bfi_e_model,    scale = "bfi_e",    group = "sex")
MI_sex_bfi_c    <- mi_via_cutoffs(data = bfi_c_data,    model = bfi_c_model,    scale = "bfi_c",    group = "sex")
MI_sex_bfi_n    <- mi_via_cutoffs(data = bfi_n_data,    model = bfi_n_model,    scale = "bfi_n",    group = "sex")
MI_sex_bfi_a    <- mi_via_cutoffs(data = bfi_a_data,    model = bfi_a_model,    scale = "bfi_a",    group = "sex")
MI_sex_bfi_o    <- mi_via_cutoffs(data = bfi_o_data,    model = bfi_o_model,    scale = "bfi_o",    group = "sex")
MI_sex_bidr_im  <- mi_via_cutoffs(data = bidr_im_data,  model = bidr_im_model,  scale = "bidr_im",  group = "sex")
MI_sex_bidr_sde <- mi_via_cutoffs(data = bidr_sde_data, model = bidr_sde_model, scale = "bidr_sde", group = "sex")
MI_sex_bjw      <- mi_via_cutoffs(data = bjw_data,      model = bjw_model,      scale = "bjw",      group = "sex")
MI_sex_brs      <- mi_via_cutoffs(data = brs_data,      model = brs_model,      scale = "brs",      group = "sex")
MI_sex_he       <- mi_via_cutoffs(data = he_data,       model = he_model,       scale = "he",       group = "sex")
MI_sex_icat_o   <- mi_via_cutoffs(data = icat_o_data,   model = icat_o_model,   scale = "icat_o",   group = "sex")
MI_sex_icat_s   <- mi_via_cutoffs(data = icat_s_data,   model = icat_s_model,   scale = "icat_s",   group = "sex")
MI_sex_nfc      <- mi_via_cutoffs(data = nfc_data,      model = nfc_model,      scale = "nfc",      group = "sex")
MI_sex_nfcc_pdc <- mi_via_cutoffs(data = nfcc_pdc_data, model = nfcc_pdc_model, scale = "nfcc_pdc", group = "sex")
MI_sex_nfcc_ao  <- mi_via_cutoffs(data = nfcc_ao_data,  model = nfcc_ao_model,  scale = "nfcc_ao",  group = "sex")
MI_sex_pe       <- mi_via_cutoffs(data = pe_data,       model = pe_model,       scale = "pe",       group = "sex")
MI_sex_pns      <- mi_via_cutoffs(data = pns_data,      model = pns_model,      scale = "pns",      group = "sex")
MI_sex_rse      <- mi_via_cutoffs(data = rse_data,      model = rse_model,      scale = "rse",      group = "sex")
MI_sex_rwa      <- mi_via_cutoffs(data = rwa_data,      model = rwa_model,      scale = "rwa",      group = "sex")
MI_sex_sdo      <- mi_via_cutoffs(data = sdo_data,      model = sdo_model,      scale = "sdo",      group = "sex")
MI_sex_sm       <- mi_via_cutoffs(data = sm_data,       model = sm_model,       scale = "sm",       group = "sex")
MI_sex_soc_ic   <- mi_via_cutoffs(data = soc_ic_data,   model = soc_ic_model,   scale = "soc_ic",   group = "sex")
MI_sex_soc_pe   <- mi_via_cutoffs(data = soc_pe_data,   model = soc_pe_model,   scale = "soc_pe",   group = "sex")
# full scales
MI_sex_bidr     <- mi_via_cutoffs(data = bidr_data,     model = bidr_model,     scale = "bidr",     group = "sex")
MI_sex_icat     <- mi_via_cutoffs(data = icat_data,     model = icat_model,     scale = "icat",     group = "sex")
MI_sex_nfcc     <- mi_via_cutoffs(data = nfcc_data,     model = nfcc_model,     scale = "nfcc",     group = "sex")
MI_sex_soc      <- mi_via_cutoffs(data = soc_data,      model = soc_model,      scale = "soc",      group = "sex")

# mi for median age
# split scales
MI_age_bfi_e    <- mi_via_cutoffs(data = bfi_e_data,    model = bfi_e_model,    scale = "bfi_e",    group = "age")
MI_age_bfi_c    <- mi_via_cutoffs(data = bfi_c_data,    model = bfi_c_model,    scale = "bfi_c",    group = "age")
MI_age_bfi_n    <- mi_via_cutoffs(data = bfi_n_data,    model = bfi_n_model,    scale = "bfi_n",    group = "age")
MI_age_bfi_a    <- mi_via_cutoffs(data = bfi_a_data,    model = bfi_a_model,    scale = "bfi_a",    group = "age")
MI_age_bfi_o    <- mi_via_cutoffs(data = bfi_o_data,    model = bfi_o_model,    scale = "bfi_o",    group = "age")
MI_age_bidr_im  <- mi_via_cutoffs(data = bidr_im_data,  model = bidr_im_model,  scale = "bidr_im",  group = "age")
MI_age_bidr_sde <- mi_via_cutoffs(data = bidr_sde_data, model = bidr_sde_model, scale = "bidr_sde", group = "age")
MI_age_bjw      <- mi_via_cutoffs(data = bjw_data,      model = bjw_model,      scale = "bjw",      group = "age")
MI_age_brs      <- mi_via_cutoffs(data = brs_data,      model = brs_model,      scale = "brs",      group = "age")
MI_age_he       <- mi_via_cutoffs(data = he_data,       model = he_model,       scale = "he",       group = "age")
MI_age_icat_o   <- mi_via_cutoffs(data = icat_o_data,   model = icat_o_model,   scale = "icat_o",   group = "age")
MI_age_icat_s   <- mi_via_cutoffs(data = icat_s_data,   model = icat_s_model,   scale = "icat_s",   group = "age")
MI_age_nfc      <- mi_via_cutoffs(data = nfc_data,      model = nfc_model,      scale = "nfc",      group = "age")
MI_age_nfcc_pdc <- mi_via_cutoffs(data = nfcc_pdc_data, model = nfcc_pdc_model, scale = "nfcc_pdc", group = "age")
MI_age_nfcc_ao  <- mi_via_cutoffs(data = nfcc_ao_data,  model = nfcc_ao_model,  scale = "nfcc_ao",  group = "age")
MI_age_pe       <- mi_via_cutoffs(data = pe_data,       model = pe_model,       scale = "pe",       group = "age")
MI_age_pns      <- mi_via_cutoffs(data = pns_data,      model = pns_model,      scale = "pns",      group = "age")
MI_age_rse      <- mi_via_cutoffs(data = rse_data,      model = rse_model,      scale = "rse",      group = "age")
MI_age_rwa      <- mi_via_cutoffs(data = rwa_data,      model = rwa_model,      scale = "rwa",      group = "age")
MI_age_sdo      <- mi_via_cutoffs(data = sdo_data,      model = sdo_model,      scale = "sdo",      group = "age")
MI_age_sm       <- mi_via_cutoffs(data = sm_data,       model = sm_model,       scale = "sm",       group = "age")
MI_age_soc_ic   <- mi_via_cutoffs(data = soc_ic_data,   model = soc_ic_model,   scale = "soc_ic",   group = "age")
MI_age_soc_pe   <- mi_via_cutoffs(data = soc_pe_data,   model = soc_pe_model,   scale = "soc_pe",   group = "age")
# full scales
MI_age_bidr     <- mi_via_cutoffs(data = bidr_data,     model = bidr_model,     scale = "bidr",     group = "age")
MI_age_icat     <- mi_via_cutoffs(data = icat_data,     model = icat_model,     scale = "icat",     group = "age")
MI_age_nfcc     <- mi_via_cutoffs(data = nfcc_data,     model = nfcc_model,     scale = "nfcc",     group = "age")
MI_age_soc      <- mi_via_cutoffs(data = soc_data,      model = soc_model,      scale = "soc",      group = "age")

# combine
## fit indices
MI_combined_fit_indicies <-
  rbind(MI_sex_bfi_e$fit_indices,
        MI_sex_bfi_c$fit_indices,
        MI_sex_bfi_n$fit_indices,
        MI_sex_bfi_a$fit_indices,
        MI_sex_bfi_o$fit_indices,
        MI_sex_bidr_im$fit_indices,
        MI_sex_bidr_sde$fit_indices,
        MI_sex_bjw$fit_indices,
        MI_sex_brs$fit_indices,
        MI_sex_he$fit_indices,
        MI_sex_icat_o$fit_indices,
        MI_sex_icat_s$fit_indices,
        MI_sex_nfc$fit_indices,
        MI_sex_nfcc_pdc$fit_indices,
        MI_sex_nfcc_ao$fit_indices,
        MI_sex_pe$fit_indices,
        MI_sex_pns$fit_indices,
        MI_sex_rse$fit_indices,
        MI_sex_rwa$fit_indices,
        MI_sex_sdo$fit_indices,
        MI_sex_sm$fit_indices,
        MI_sex_soc_ic$fit_indices,
        MI_sex_soc_pe$fit_indices,
        MI_sex_bidr$fit_indices,
        MI_sex_icat$fit_indices,
        MI_sex_nfcc$fit_indices,
        MI_sex_soc$fit_indices,
        MI_age_bfi_e$fit_indices,
        MI_age_bfi_c$fit_indices,
        MI_age_bfi_n$fit_indices,
        MI_age_bfi_a$fit_indices,
        MI_age_bfi_o$fit_indices,
        MI_age_bidr_im$fit_indices,
        MI_age_bidr_sde$fit_indices,
        MI_age_bjw$fit_indices,
        MI_age_brs$fit_indices,
        MI_age_he$fit_indices,
        MI_age_icat_o$fit_indices,
        MI_age_icat_s$fit_indices,
        MI_age_nfc$fit_indices,
        MI_age_nfcc_pdc$fit_indices,
        MI_age_nfcc_ao$fit_indices,
        MI_age_pe$fit_indices,
        MI_age_pns$fit_indices,
        MI_age_rse$fit_indices,
        MI_age_rwa$fit_indices,
        MI_age_sdo$fit_indices,
        MI_age_sm$fit_indices,
        MI_age_soc_ic$fit_indices,
        MI_age_soc_pe$fit_indices,
        MI_age_bidr$fit_indices,
        MI_age_icat$fit_indices,
        MI_age_nfcc$fit_indices,
        MI_age_soc$fit_indices) %>%
  mutate(Scale = dplyr::recode(Scale,
                               "bfi_e"    = "Big 5 Inventory - E",
                               "bfi_c"    = "Big 5 Inventory - C",
                               "bfi_n"    = "Big 5 Inventory - N",
                               "bfi_a"    = "Big 5 Inventory - A",
                               "bfi_o"    = "Big 5 Inventory - O",
                               "bidr_im"  = "Balanced Inventory of Desirable Responding - Impression Management",
                               "bidr_sde" = "Balanced Inventory of Desirable Responding - Self Deception",
                               "bjw"      = "Belief in a Just World: General Just World Scale",
                               "brs"      = "Bayesian Racism",
                               "he"       = "Humanitarianism-Egalitarianism",
                               "icat_o"   = "Intuitions about Controllability and Awareness of Thoughts - Others",
                               "icat_s"   = "Intuitions about Controllability and Awareness of Thoughts - Self",
                               "nfc"      = "Need for Cognition",
                               "nfcc_pdc" = "Need for Cognitive Closure - P,D,CM",
                               "nfcc_ao"  = "Need for Cognitive Closure - O,A",
                               "pe"       = "Protestant Ethic",
                               "pns"      = "Personal Need for Structure",
                               "rse"      = "Rosenberg Self-Esteem",
                               "rwa"      = "Ring-Wing Authoritarianism",
                               "sdo"      = "Social Dominance Orientation",
                               "sm"       = "Self-Monitoring",
                               "soc_ic"   = "Spheres of Control - Interpersonal Control",
                               "soc_pe"   = "Spheres of Control - Personal Efficacy")) %>%
  rename(df = df.scaled,
         fit_chisq_p_value = pvalue.scaled,
         chisq = chisq.scaled,
         srmr = srmr,
         cfi = cfi.scaled,
         tli = tli.scaled,
         rmsea = rmsea.scaled)

## change in fit indices
MI_combined_change_in_fit_indices <-
  rbind(MI_sex_bfi_e$fit_deltas,
        MI_sex_bfi_c$fit_deltas,
        MI_sex_bfi_n$fit_deltas,
        MI_sex_bfi_a$fit_deltas,
        MI_sex_bfi_o$fit_deltas,
        MI_sex_bidr_im$fit_deltas,
        MI_sex_bidr_sde$fit_deltas,
        MI_sex_bjw$fit_deltas,
        MI_sex_brs$fit_deltas,
        MI_sex_he$fit_deltas,
        MI_sex_icat_o$fit_deltas,
        MI_sex_icat_s$fit_deltas,
        MI_sex_nfc$fit_deltas,
        MI_sex_nfcc_pdc$fit_deltas,
        MI_sex_nfcc_ao$fit_deltas,
        MI_sex_pe$fit_deltas,
        MI_sex_pns$fit_deltas,
        MI_sex_rse$fit_deltas,
        MI_sex_rwa$fit_deltas,
        MI_sex_sdo$fit_deltas,
        MI_sex_sm$fit_deltas,
        MI_sex_soc_ic$fit_deltas,
        MI_sex_soc_pe$fit_deltas,
        MI_sex_bidr$fit_deltas,
        MI_sex_icat$fit_deltas,
        MI_sex_nfcc$fit_deltas,
        MI_sex_soc$fit_deltas,
        MI_age_bfi_e$fit_deltas,
        MI_age_bfi_c$fit_deltas,
        MI_age_bfi_n$fit_deltas,
        MI_age_bfi_a$fit_deltas,
        MI_age_bfi_o$fit_deltas,
        MI_age_bidr_im$fit_deltas,
        MI_age_bidr_sde$fit_deltas,
        MI_age_bjw$fit_deltas,
        MI_age_brs$fit_deltas,
        MI_age_he$fit_deltas,
        MI_age_icat_o$fit_deltas,
        MI_age_icat_s$fit_deltas,
        MI_age_nfc$fit_deltas,
        MI_age_nfcc_pdc$fit_deltas,
        MI_age_nfcc_ao$fit_deltas,
        MI_age_pe$fit_deltas,
        MI_age_pns$fit_deltas,
        MI_age_rse$fit_deltas,
        MI_age_rwa$fit_deltas,
        MI_age_sdo$fit_deltas,
        MI_age_sm$fit_deltas,
        MI_age_soc_ic$fit_deltas,
        MI_age_soc_pe$fit_deltas,
        MI_age_bidr$fit_deltas,
        MI_age_icat$fit_deltas,
        MI_age_nfcc$fit_deltas,
        MI_age_soc$fit_deltas) %>%
  mutate(Scale = dplyr::recode(Scale,
                               "bfi_e"    = "Big 5 Inventory - E",
                               "bfi_c"    = "Big 5 Inventory - C",
                               "bfi_n"    = "Big 5 Inventory - N",
                               "bfi_a"    = "Big 5 Inventory - A",
                               "bfi_o"    = "Big 5 Inventory - O",
                               "bidr_im"  = "Balanced Inventory of Desirable Responding - Impression Management",
                               "bidr_sde" = "Balanced Inventory of Desirable Responding - Self Deception",
                               "bjw"      = "Belief in a Just World: General Just World Scale",
                               "brs"      = "Bayesian Racism",
                               "he"       = "Humanitarianism-Egalitarianism",
                               "icat_o"   = "Intuitions about Controllability and Awareness of Thoughts - Others",
                               "icat_s"   = "Intuitions about Controllability and Awareness of Thoughts - Self",
                               "nfc"      = "Need for Cognition",
                               "nfcc_pdc" = "Need for Cognitive Closure - P,D,CM",
                               "nfcc_ao"  = "Need for Cognitive Closure - O,A",
                               "pe"       = "Protestant Ethic",
                               "pns"      = "Personal Need for Structure",
                               "rse"      = "Rosenberg Self-Esteem",
                               "rwa"      = "Ring-Wing Authoritarianism",
                               "sdo"      = "Social Dominance Orientation",
                               "sm"       = "Self-Monitoring",
                               "soc_ic"   = "Spheres of Control - Interpersonal Control",
                               "soc_pe"   = "Spheres of Control - Personal Efficacy"),
         test = ifelse(test == "fit_metric - fit_configural", "fit_metric",
                       ifelse(test == "fit_scalar - fit_scalar", "fit_scalar", NA))) %>%
  rename(df_change = df.scaled,
         srmr_change = srmr,
         cfi_change = cfi.scaled,
         tli_change = tli.scaled,
         rmsea_change = rmsea.scaled)

measurement_invariance_full_results <- MI_combined_fit_indicies %>%
  left_join(MI_combined_change_in_fit_indices, by = c("Scale", "group", "test")) %>%
  arrange(Scale, group, test) %>%
  mutate(MI_test = ifelse(!is.na(MI_config), MI_config, MI_delta)) %>%
  select(Scale, group, test, 
         chisq, df, fit_chisq_p_value, cfi, tli, rmsea, srmr, 
         df_change, cfi_change, tli_change, rmsea_change, srmr_change, MI_test)


# save full results to disk for reporting
write_csv(measurement_invariance_full_results, "results/measurement_invariance_full_results.csv")

# summarize results in categorical terms
MI_results_temp_1 <- measurement_invariance_full_results %>%
  mutate(MI_test = ifelse(MI_test %in% c("Good", "Mixed"), "Passed",
                          ifelse(MI_test == "Poor", "Failed", MI_test))) %>%
  select(Scale, group, test, MI_test) %>%
  spread(test, MI_test) %>%
  mutate(MI_test = ifelse(fit_configural == "Passed" & fit_metric == "Passed" & fit_scalar == "Passed", "Passed", "Failed"),
         MI_test_failed = ifelse(fit_configural == "Failed", "Configural",
                                 ifelse(fit_metric == "Failed", "Metric",
                                        ifelse(fit_scalar == "Failed", "Scalar", NA))))

MI_results_temp_2 <- MI_results_temp_1 %>%
  select(Scale, group, MI_test) %>%
  spread(group, MI_test) %>%
  rename(MI_age = age,
         MI_sex = sex) %>%
  mutate(MI_test = ifelse(MI_age == "Passed" & MI_sex == "Passed", "Passed", "Failed")) 

MI_results_temp_3 <- MI_results_temp_1 %>%
  select(Scale, group, MI_test_failed) %>%
  spread(group, MI_test_failed) %>%
  rename(MI_age_test_failed = age,
         MI_sex_test_failed = sex)

MI_results <- full_join(MI_results_temp_2, MI_results_temp_3, by = "Scale") %>%
  select(Scale, MI_test, MI_age, MI_age_test_failed, MI_sex, MI_sex_test_failed)

```

## Combined table of results

```{r}

combined_results <- cfi_fit_results %>%
  left_join(dist_results,          by = "Scale") %>%
  left_join(consistency_results,   by = "Scale") %>%
  left_join(dependability_results, by = "Scale") %>%
  left_join(stability_results,     by = "Scale") %>%
  left_join(MI_results,            by = "Scale") %>%

  # apply cutoffs to reliability metrics
  dplyr::mutate(alpha_test   = ifelse(alpha >= .7,   "Passed", "Failed"),
                omega_t_test = ifelse(omega_t >= .7, "Passed", "Failed"),
                omega_h_test = ifelse(omega_h >= .7, "Passed", "Failed"),
                dependability_test = ifelse("Test-retest dependability r" >= .7, "Passed", "Failed"),
                stability_test     = ifelse("Test-retest stability r" >= .7,     "Passed", "Failed"),
                test_retest_test = ifelse(dependability_test == "Passed" & stability_test == "Passed", "Passed",
                                          ifelse(dependability_test == "Failed" & stability_test == "Failed", "Failed", NA)),
                overall_scale_test = ifelse(omega_t >= .7 &
                                              ("Test-retest dependability r" >= .7 |
                                                 is.na(`Test-retest dependability r`)) &
                                              ("Test-retest stability r" >= .7 |
                                                 is.na(`Test-retest stability r`)) &
                                              (cfa_test == "Good" | cfa_test == "Mixed") &
                                              MI_test == "Passed", "Good", "Questionable")) %>%
  # reorder columns
  dplyr::select(Scale, n, Factors, Items,
                M, SD, Skewness, Kurtosis,
                # internal consistency
                alpha, alpha_ci_lower, alpha_ci_upper, alpha_test, 
                omega_t, omega_t_ci_lower, omega_t_ci_upper, omega_t_test,
                omega_h, omega_h_ci_lower, omega_h_ci_upper, omega_h_test,
                # test-retest reliability
                "Test-retest dependability n", "Test-retest dependability r", 
                "dependability r lower", "dependability r upper", dependability_test,
                "Test-retest stability n", "Test-retest stability r", "stability r lower", "stability r upper", stability_test,
                test_retest_test,
                # cfa fit
                chisq, "chisq/df", df, pvalue,
                cfi, tli, rmsea, rmsea.ci.lower, rmsea.ci.upper, srmr, cfa_test, 
                # measurement invariance
                MI_age, MI_age_test_failed, MI_sex, MI_sex_test_failed, MI_test, 
                # summary
                overall_scale_test,
                # details
                Changes, Interpretation) %>%
  arrange(Scale)

# write to disk
save(combined_results, file = "results/results.Rdata")
write_csv(combined_results, "results/results.csv", na = "")
#load("results/combined_results.Rdata")

```

# Summary table

```{r}

# convert string conclusions to binary pass/fail
binarized_combined_results <- combined_results %>%
  mutate(alpha_test         = ifelse(alpha_test == "Passed", 1, 
                                     ifelse(alpha_test == "Failed", 0, NA)),
         test_retest_test   = ifelse(test_retest_test == "Passed", 1, 
                                     ifelse(test_retest_test == "Failed", 0, NA)),
         cfa_test           = ifelse(cfa_test == "Mixed" | cfa_test == "Good", 1, 
                                     ifelse(cfa_test == "Poor", 0, NA)),
         MI_test            = ifelse(MI_test == "Passed", 1,
                                     ifelse(MI_test == "Failed", 0, NA)),
         overall_scale_test = ifelse(overall_scale_test == "Good", 1, 
                                     ifelse(overall_scale_test == "Questionable", 0, NA))) %>%
  select(Scale, 
         alpha_test, 
         test_retest_test,
         cfa_test, 
         MI_test, 
         overall_scale_test)

# summarize across scales
summarized_combined_results <- binarized_combined_results %>%
  gather(key, value, -Scale) %>%
  group_by(key) %>%
  summarize(percent = as.character(round(mean(value, na.rm = TRUE)*100, 1))) %>%
  spread(key, percent) %>%
  mutate(Scale = "Summary")

# create table of summarized results
summary_table <- combined_results %>%
  bind_rows(summarized_combined_results) %>%
  rename("Internal consistency" = alpha_test,
         "Test-retest reliability" = test_retest_test, 
         "Confirmatory factor structure" = cfa_test, 
         "Measurement invariance" = MI_test, 
         "Global structural validity" = overall_scale_test) %>%
  select(Scale, 
         "Internal consistency",
         "Test-retest reliability",
         "Confirmatory factor structure",
         "Measurement invariance",
         "Global structural validity")

save(summary_table, file = "results/summary_table.Rdata")
write_csv(summary_table, "results/summary_table.csv", na = "")

summary_table %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

```

# Alluvial plot

```{r fig.height=4, fig.width=7}

# subset
data_alluvial_plot <- binarized_combined_results %>%
  dplyr::count(alpha_test, test_retest_test, cfa_test, MI_test) %>%
  rownames_to_column() %>%
  tidyr::gather(key = "metric",
                value = "validity",
                -c(rowname, n)) %>%
  mutate(validity = ifelse(is.na(validity), 2, validity),
         validity = dplyr::recode(validity,
                                  `0` = "Fail",
                                  `1` = "Pass",
                                  `2` = "NA"),
         validity = forcats::fct_relevel(as.factor(validity),
                                         "Fail", "NA", "Pass"),
         metric = dplyr::recode(as.character(metric),
                                "alpha_test" = "Internal\nconsistency",
                                "test_retest_test" = "Test-retest\nreliability",
                                "cfa_test" = "Factor\nstructure",
                                "MI_test" = "Measurement\ninvariance"),
         metric = forcats::fct_relevel(as.factor(metric),
                                       "Internal\nconsistency",
                                       "Test-retest\nreliability",
                                       "Factor\nstructure",
                                       "Measurement\ninvariance"))

# alluvial plot with flow
ggplot(data_alluvial_plot,
       aes(x = metric,
           stratum = validity,
           alluvium = rowname,
           y = n,
           fill = validity,
           label = validity)) +
  geom_flow(alpha = .5) +
  geom_stratum(alpha = .8) +
  theme_classic() +
  geom_text(stat = "stratum", size = 3) + # , angle = 90
  theme(legend.position = "none") +
  ylab("Number of scales\nmeeting criteria") +
  xlab("") +
  scale_fill_viridis_d(option = "viridis", direction = -1, begin = 0.3, end = 0.7)

```
